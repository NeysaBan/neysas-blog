
---
title: "openmpâ€”â€”å…³äºæ ¸æ‰“æ»¡çš„é—®é¢˜"
date: "2023-06-25"
author: "NeysaBan"
excerpt: "openmpå¹¶è¡Œè®¾ç½®+linuxçº¿ç¨‹è°ƒåº¦"
category: "cpu"
tags:
- cpu
- openmp
readTime: "10åˆ†é’Ÿ"
---

## é—®é¢˜

<aside>
â“ å®ä¹ ä¸­ï¼Œåœ¨ä¸€ä¸ªç®—æ³•moduleçš„çƒ­ç‚¹å‡½æ•°ä¸­ï¼Œä½¿ç”¨openmpå¹¶è¡Œå‡å°‘äº†å‡½æ•°çš„è€—æ—¶ï¼Œç„¶è€Œè¿™ç§æ–¹æ³•ä¼šå æ»¡openmpåˆ†é…åˆ°çš„æ ¸ï¼Œè¿™ç§æƒ…å†µæ˜¯ä¸å…è®¸å‡ºç°çš„ã€‚

æ‰€ä»¥ä»»åŠ¡æ˜¯ï¼Œè®©çº¿ç¨‹ä¸ä¼šå æ»¡æ ¸ï¼Œè€—æ—¶åˆèƒ½æ¯”è¾ƒå¥½çœ‹

</aside>

## æµ‹è¯•å¹³å°

![Untitled](openmp%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E6%A0%B8%E6%89%93%E6%BB%A1%E7%9A%84%E9%97%AE%E9%A2%98/Untitled.png)

## åŸå§‹ä»£ç 

- cpuäº²å’Œæ€§ï¼šç”±äºæœ‰ä¸¤ä¸ªcpuï¼Œæ‰€ä»¥å¹¶è¡Œæ—¶æ³¨æ„ç»‘å®šcpuï¼Œé˜²æ­¢ç­–ç•¥è®¾ç½®ä¸ç”Ÿæ•ˆ [ğŸ”—](https://cloud.tencent.com/developer/article/1837821)
    
    ```cpp
    cpu_set_t mask;
    int cpus = sysconf(_SC_NPROCESSORS_CONF);
    CPU_ZERO(&mask);
    CPU_SET(0, &mask);
    ```
    
- ç¼–è¯‘ `g++ xxx.cpp -o xxx -fopenmp`
- åŸå§‹ä»£ç  78.1584ms
    
    ```cpp
    #include<iostream>
    #include <omp.h>
    #include<unistd.h>
    #include <cstdio>
    using namespace std;
     
    #define openmp
     
    #define M 16384 * 3
    #define N 16384 * 3
     
    static double get_time(struct timespec *start,
                           struct timespec *end) {
        return end->tv_sec - start->tv_sec + (end->tv_nsec - start->tv_nsec) * 1e-9;
    }
     
    int main(){
     
        float x, y, z, factor = 1.1,
                cx = 2.1, cy = 3.1,
                fx = 4.1, fy = 5.1;
     
        struct timespec start, end;
        double time_tmp;
     
        clock_gettime(CLOCK_MONOTONIC_RAW, &start);
     
        for (int v = 0; v < M * 4; v += 4)
        {
            for (int u = 0; u < N * 4; u += 4)
            {
                float Z = 3.2 / factor;
      
                z = Z;
                x = (u - cx) * Z / fx;
                y = (v - cy) * Z / fy;
      
                z = z / 1000;
                x = x / 1000;
                y = y / 1000;
     
            }
        }
        clock_gettime(CLOCK_MONOTONIC_RAW, &end);
        time_tmp = get_time(&start, &end);
        cout<<"time : "<<time_tmp<<"ms\n";
    }
     
    // ç”±äºè¿è¡Œæ—¶éœ€è¦ä¿®æ”¹cgroupsä¸­çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦åˆ‡æ¢åˆ°rootå†è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæœ€åè¿è¡Œè„šæœ¬
    ```
    
- æœ´ç´ ompä»£ç   43.3821ms
    
    ```cpp
    #include<iostream>
    #include <omp.h>
    #include<unistd.h>
    #include <cstdio>
    using namespace std;
     
    #define openmp
     
    #define M 16384 * 3
    #define N 16384 * 3
     
    static double get_time(struct timespec *start,
                           struct timespec *end) {
        return end->tv_sec - start->tv_sec + (end->tv_nsec - start->tv_nsec) * 1e-9;
    }
     
    int main(){
     
        float x, y, z, factor = 1.1,
                cx = 2.1, cy = 3.1,
                fx = 4.1, fy = 5.1;
     
        struct timespec start, end;
        double time_tmp;
     
        clock_gettime(CLOCK_MONOTONIC_RAW, &start);
         
        #ifdef openmp
        #pragma omp parallel for
        #endif
     
        for (int v = 0; v < M * 4; v += 4)
        {
            for (int u = 0; u < N * 4; u += 4)
            {
                float Z = 3.2 / factor;
      
                z = Z;
                x = (u - cx) * Z / fx;
                y = (v - cy) * Z / fy;
      
                z = z / 1000;
                x = x / 1000;
                y = y / 1000;
     
            }
        }
        clock_gettime(CLOCK_MONOTONIC_RAW, &end);
        time_tmp = get_time(&start, &end);
        cout<<"time : "<<time_tmp<<"ms\n";
    }
     
    // ç”±äºè¿è¡Œæ—¶éœ€è¦ä¿®æ”¹cgroupsä¸­çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦åˆ‡æ¢åˆ°rootå†è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæœ€åè¿è¡Œè„šæœ¬
    ```
    

![Untitled](openmp%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E6%A0%B8%E6%89%93%E6%BB%A1%E7%9A%84%E9%97%AE%E9%A2%98/Untitled%201.png)

## openmpå…¥æ‰‹

openmpæ— æ³•ç›´æ¥æŸ¥çœ‹æºä»£ç ï¼Œå› ä¸ºopenmpåº“éƒ½æ˜¯éšç¼–è¯‘å™¨ä¸€èµ·å‘å¸ƒçš„ï¼Œå¦‚æœä½ çš„ç¨‹åºæ˜¯æºä»£ç ç¼–è¯‘çš„ï¼Œåªè¦ç¼–è¯‘å™¨æ”¯æŒopenmpç¼–è¯‘é€‰é¡¹å°±è‚¯å®šèƒ½ç”¨ï¼Œä¹Ÿæ„å‘³ç€æ— æ³•ç›´æ¥æŸ¥çœ‹openmpçš„æºä»£ç  [ğŸ”—](https://hpc-tutorials.llnl.gov/openmp/api_overview/)

![Untitled](openmp%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E6%A0%B8%E6%89%93%E6%BB%A1%E7%9A%84%E9%97%AE%E9%A2%98/Untitled%202.png)

å› æ­¤

- ç›´æ¥æœç´¢ç½‘ä¸Šé‡åˆ°ç±»ä¼¼é—®é¢˜çš„
    - [Tencent/ncnn/openmp best practice](https://github.com/Tencent/ncnn/wiki/openmp-best-practice)
        - å¯èƒ½çš„åŸå› ï¼šopenmpå†…éƒ¨çš„çº¿ç¨‹æ± æœ€å¤§å¯ç”¨çº¿ç¨‹æ•°ç­‰äºcpuå†…æ ¸æ•°ï¼Œè·å–å’Œå½’è¿˜çº¿ç¨‹æ—¶éœ€è¦åŒæ­¥ã€‚çº¿ç¨‹è¢«è°ƒåº¦æ—¶ï¼Œæ˜¯ä½¿ç”¨è‡ªæ—‹é”ï¼Œé»˜è®¤çš„spin time æ˜¯200msã€‚è€Œä¸”åœ¨armä¸Šï¼Œæœ¬èº«è·å–é‡Šæ”¾é”çš„å¼€é”€å°±å¾ˆå¤§
            - method 1 : å‡å°‘çº¿ç¨‹æ•°ï¼ˆå‡å°‘çº¿ç¨‹è°ƒåº¦çš„è€—è´¹æ—¶é—´ï¼‰[åŒæ ·è®¾ç½®ğŸ”—](https://coderatwork.cn/posts/optimize-ai-reference-svc/)
                - é™åˆ¶çº¿ç¨‹æ•°é‡ä¸º32   35.0423ms
                    
                    num_threads > omp_set_num_threads > OMP_NUM_THREADS // å…¶å®åœ¨æœ¬ç¨‹åºä¸­éƒ½æ˜¯ä¸€æ ·çš„
                    
                    ```cpp
                    #include<iostream>
                    #include <omp.h>
                    #include<unistd.h>
                    #include <cstdio>
                    using namespace std;
                     
                    #define openmp
                     
                    #define M 16384 * 3
                    #define N 16384 * 3
                     
                    static double get_time(struct timespec *start,
                                           struct timespec *end) {
                        return end->tv_sec - start->tv_sec + (end->tv_nsec - start->tv_nsec) * 1e-9;
                    }
                     
                    int main(){
                     
                        float x, y, z, factor = 1.1,
                                cx = 2.1, cy = 3.1,
                                fx = 4.1, fy = 5.1;
                    
                    		cpu_set_t mask;
                        int cpus = sysconf(_SC_NPROCESSORS_CONF);
                        CPU_ZERO(&mask);
                        CPU_SET(0, &mask);
                     
                        struct timespec start, end;
                        double time_tmp;
                     
                        clock_gettime(CLOCK_MONOTONIC_RAW, &start);
                         
                        #ifdef openmp
                        #pragma omp parallel for num_threads(32)
                        #endif
                     
                        for (int v = 0; v < M * 4; v += 4)
                        {
                            for (int u = 0; u < N * 4; u += 4)
                            {
                                float Z = 3.2 / factor;
                      
                                z = Z;
                                x = (u - cx) * Z / fx;
                                y = (v - cy) * Z / fy;
                      
                                z = z / 1000;
                                x = x / 1000;
                                y = y / 1000;
                     
                            }
                        }
                        clock_gettime(CLOCK_MONOTONIC_RAW, &end);
                        time_tmp = get_time(&start, &end);
                        cout<<"time : "<<time_tmp<<"ms\n";
                    }
                     
                    // ç”±äºè¿è¡Œæ—¶éœ€è¦ä¿®æ”¹cgroupsä¸­çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦åˆ‡æ¢åˆ°rootå†è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæœ€åè¿è¡Œè„šæœ¬
                    ```
                    
                
                ![`num_threadsï¼ˆï¼‰`](openmp%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E6%A0%B8%E6%89%93%E6%BB%A1%E7%9A%84%E9%97%AE%E9%A2%98/Untitled%203.png)
                
                `num_threadsï¼ˆï¼‰`
                
                ![`export OMP_NUM_THREADS=32`](openmp%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E6%A0%B8%E6%89%93%E6%BB%A1%E7%9A%84%E9%97%AE%E9%A2%98/Untitled%204.png)
                
                `export OMP_NUM_THREADS=32`
                
            - method 2: å‡å°‘spin time ï¼ˆ[ğŸ”—](https://gcc.gnu.org/onlinedocs/libgomp/GOMP_005fSPINCOUNT.html) ï¼‰
                
                å®éªŒè¿‡ç¨‹ä¸­è®°å¾—ä½¿ç”¨`export OMP_DISPLAY_ENV="TRUEâ€` æ˜¾ç¤ºç¯å¢ƒå˜é‡çš„è®¾ç½®
                
                - method 2.1 : `export OMP_WAIT_POLICY=PASSIVE` ç¦ç”¨spin time
                    - 35.8061ms
                        
                        ```cpp
                        #include<iostream>
                        #include <omp.h>
                        #include<unistd.h>
                        #include <cstdio>
                        using namespace std;
                         
                        #define openmp
                         
                        #define M 16384 * 3
                        #define N 16384 * 3
                         
                        static double get_time(struct timespec *start,
                                               struct timespec *end) {
                            return end->tv_sec - start->tv_sec + (end->tv_nsec - start->tv_nsec) * 1e-9;
                        }
                         
                        int main(){
                         
                            float x, y, z, factor = 1.1,
                                    cx = 2.1, cy = 3.1,
                                    fx = 4.1, fy = 5.1;
                        
                        		cpu_set_t mask;
                            int cpus = sysconf(_SC_NPROCESSORS_CONF);
                            CPU_ZERO(&mask);
                            CPU_SET(0, &mask);
                         
                            struct timespec start, end;
                            double time_tmp;
                         
                            clock_gettime(CLOCK_MONOTONIC_RAW, &start);
                             
                            #ifdef openmp
                            #pragma omp parallel for num_threads(32)
                            #endif
                         
                            for (int v = 0; v < M * 4; v += 4)
                            {
                                for (int u = 0; u < N * 4; u += 4)
                                {
                                    float Z = 3.2 / factor;
                          
                                    z = Z;
                                    x = (u - cx) * Z / fx;
                                    y = (v - cy) * Z / fy;
                          
                                    z = z / 1000;
                                    x = x / 1000;
                                    y = y / 1000;
                         
                                }
                            }
                            clock_gettime(CLOCK_MONOTONIC_RAW, &end);
                            time_tmp = get_time(&start, &end);
                            cout<<"time : "<<time_tmp<<"ms\n";
                        }
                         
                        // ç”±äºè¿è¡Œæ—¶éœ€è¦ä¿®æ”¹cgroupsä¸­çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦åˆ‡æ¢åˆ°rootå†è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæœ€åè¿è¡Œè„šæœ¬
                        ```
                        
                    
                    ![Untitled](openmp%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E6%A0%B8%E6%89%93%E6%BB%A1%E7%9A%84%E9%97%AE%E9%A2%98/Untitled%205.png)
                    
                - method 2.2: `export GOMP_SPINCOUNT=2 && export OMP_WAIT_POLICY=ACTIVE`
                    - 34.3107ms
                        
                        ```cpp
                        #include<iostream>
                        #include <omp.h>
                        #include<unistd.h>
                        #include <cstdio>
                        using namespace std;
                         
                        #define openmp
                         
                        #define M 16384 * 3
                        #define N 16384 * 3
                         
                        static double get_time(struct timespec *start,
                                               struct timespec *end) {
                            return end->tv_sec - start->tv_sec + (end->tv_nsec - start->tv_nsec) * 1e-9;
                        }
                         
                        int main(){
                         
                            float x, y, z, factor = 1.1,
                                    cx = 2.1, cy = 3.1,
                                    fx = 4.1, fy = 5.1;
                         
                            struct timespec start, end;
                            double time_tmp;
                         
                            clock_gettime(CLOCK_MONOTONIC_RAW, &start);
                        
                        		cpu_set_t mask;
                            int cpus = sysconf(_SC_NPROCESSORS_CONF);
                            CPU_ZERO(&mask);
                            CPU_SET(0, &mask);
                             
                            #ifdef openmp
                            #pragma omp parallel for num_threads(32)
                            #endif
                         
                            for (int v = 0; v < M * 4; v += 4)
                            {
                                for (int u = 0; u < N * 4; u += 4)
                                {
                                    float Z = 3.2 / factor;
                          
                                    z = Z;
                                    x = (u - cx) * Z / fx;
                                    y = (v - cy) * Z / fy;
                          
                                    z = z / 1000;
                                    x = x / 1000;
                                    y = y / 1000;
                         
                                }
                            }
                            clock_gettime(CLOCK_MONOTONIC_RAW, &end);
                            time_tmp = get_time(&start, &end);
                            cout<<"time : "<<time_tmp<<"ms\n";
                        }
                         
                        // ç”±äºè¿è¡Œæ—¶éœ€è¦ä¿®æ”¹cgroupsä¸­çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦åˆ‡æ¢åˆ°rootå†è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæœ€åè¿è¡Œè„šæœ¬
                        ```
                        
                    
                    ![Untitled](openmp%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E6%A0%B8%E6%89%93%E6%BB%A1%E7%9A%84%E9%97%AE%E9%A2%98/Untitled%206.png)
                    
            - method 3 : é™åˆ¶openmpçº¿ç¨‹æ± å¯ç”¨çº¿ç¨‹çš„æ•°é‡  `export OMP_THREAD_LIMIT=32`
                - 34.1884ms
                    
                    ```cpp
                    #include<iostream>
                    #include <omp.h>
                    #include<unistd.h>
                    #include <cstdio>
                    using namespace std;
                     
                    #define openmp
                     
                    #define M 16384 * 3
                    #define N 16384 * 3
                     
                    static double get_time(struct timespec *start,
                                           struct timespec *end) {
                        return end->tv_sec - start->tv_sec + (end->tv_nsec - start->tv_nsec) * 1e-9;
                    }
                     
                    int main(){
                     
                        float x, y, z, factor = 1.1,
                                cx = 2.1, cy = 3.1,
                                fx = 4.1, fy = 5.1;
                    
                    		cpu_set_t mask;
                        int cpus = sysconf(_SC_NPROCESSORS_CONF);
                        CPU_ZERO(&mask);
                        CPU_SET(0, &mask);
                     
                        struct timespec start, end;
                        double time_tmp;
                     
                        clock_gettime(CLOCK_MONOTONIC_RAW, &start);
                         
                        #ifdef openmp
                        #pragma omp parallel for num_threads(32)
                        #endif
                     
                        for (int v = 0; v < M * 4; v += 4)
                        {
                            for (int u = 0; u < N * 4; u += 4)
                            {
                                float Z = 3.2 / factor;
                      
                                z = Z;
                                x = (u - cx) * Z / fx;
                                y = (v - cy) * Z / fy;
                      
                                z = z / 1000;
                                x = x / 1000;
                                y = y / 1000;
                     
                            }
                        }
                        clock_gettime(CLOCK_MONOTONIC_RAW, &end);
                        time_tmp = get_time(&start, &end);
                        cout<<"time : "<<time_tmp<<"ms\n";
                    }
                     
                    // ç”±äºè¿è¡Œæ—¶éœ€è¦ä¿®æ”¹cgroupsä¸­çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦åˆ‡æ¢åˆ°rootå†è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæœ€åè¿è¡Œè„šæœ¬
                    ```
                    
    - [OpenMPè®¾ç½®å¯¼è‡´çš„Faisså¤šçº¿ç¨‹æ€§èƒ½é—®é¢˜](https://www.zhihu.com/tardis/zm/art/118604153?source_id=1003)
        - å¯èƒ½çš„åŸå› ï¼šå’Œä¸Šé¢è¯´çš„æ„æ€å·®ä¸å¤šï¼Œopenmpå‡å®šæ‰€æœ‰è°ƒç”¨éƒ½æ˜¯è®¡ç®—å¯†é›†å‹ï¼Œä¸ºäº†å‡å°‘çº¿ç¨‹å¯åŠ¨/å”¤é†’è¿‡ç¨‹éœ€è¦ä¸Šä¸‹æ–‡å¼€é”€ï¼Œç³»ç»Ÿå¿…é¡»æ—¶åˆ»ä¿è¯æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æ˜¯aliveçŠ¶æ€ã€‚å› æ­¤openmpä¼šè®©çº¿ç¨‹æ± æ¯ä¸ªçº¿ç¨‹åšå¤§é‡æ— æ„ä¹‰çš„è®¡ç®—ï¼ˆè‡ªæ—‹é”ï¼‰å æ®æ—¶é—´ç‰‡ã€‚ã€ä¸ªäººç†è§£ï¼šä¹Ÿå°±æ˜¯è¯´ï¼Œopenmpè®¤ä¸ºçº¿ç¨‹ç­‰å¾…è‡ªæ—‹é”çš„æˆæœ¬æ¯”çº¿ç¨‹åˆ‡æ¢çš„æˆæœ¬è¦ä½ã€‘

> æ€»ç»“ï¼šå®éªŒçœ‹æ¥ï¼Œä¸Šé¢å‡ ç§æ–¹æ³•æœ€æœ‰æ•ˆçš„å°±æ˜¯å‡å°‘çº¿ç¨‹çš„æ•°é‡ï¼Œä½†æ˜¯ä»ç„¶æ²¡æœ‰è¾¾åˆ°ç†æƒ³æ•ˆæœï¼ˆè‡ªåŠ¨é©¾é©¶ç«¯ä¾§è¦æ±‚çš„æ˜¯æ¯ä¸ªæ ¸éƒ½ä¸èƒ½å æ»¡ï¼‰ï¼Œè€Œä¸Šé¢åšå®¢ç»™å‡ºçš„è§£å†³æ–¹æ¡ˆåº”è¯¥æ˜¯åªèƒ½è®©æ•´ä½“cpuå ç”¨ç‡ä¸‹é™
> 

## Linuxçº¿ç¨‹è°ƒåº¦

ç”±æ­¤ï¼Œæƒ³åˆ°çº¿ç¨‹è°ƒåº¦

- niceå€¼ï¼šæƒ³åˆ°è¿™ä¸ªçš„åŸå› æ˜¯å› ä¸ºæ“ä½œç³»ç»ŸåˆšèƒŒè¿‡ğŸ¥¹æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼ŒæŠŠå½“å‰è¿›ç¨‹çš„niceå€¼é™ä½è™½ç„¶æ ¸ä¸ä¼šæ‰“æ»¡äº†ï¼Œä½†è€—æ—¶ä¹Ÿå¤§å¤§å¢åŠ äº†ï¼Œæ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„

> ç›´æ¥è°ƒæ•´niceå€¼åªæ˜¯è‡ªå·±çš„è‡†æƒ³ï¼Œè¿˜æ˜¯è¦çœ‹ä¸€ä¸‹linuxç©¶ç«Ÿå¦‚ä½•è°ƒåº¦çº¿ç¨‹ï¼Œæ ¹æ®å®ƒçš„**è°ƒåº¦ç­–ç•¥**è°ƒæ•´æ‰æ˜¯å¯¹ç—‡ä¸‹è¯
> 

ğŸ”—Â [å‚è€ƒé“¾æ¥](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU1MDkzMzQzNQ==&action=getalbum&album_id=1344408180989853698&scene=173&from_msgid=2247484042&from_itemidx=1&count=3&nolastread=1#wechat_redirect) [é‡ç‚¹å‚è€ƒ](https://mp.weixin.qq.com/s?__biz=MzU1MDkzMzQzNQ==&mid=2247483972&idx=1&sn=4d18188c5268d0ca5579d7e005df47d8&chksm=fb984490ccefcd8634a980b73aa8ba1c27ffa2df9b314149d7334d1b7bdca860ac0b7b0b8d3d&scene=178&cur_album_id=1344408180989853698#rd)

![Untitled](openmp%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E6%A0%B8%E6%89%93%E6%BB%A1%E7%9A%84%E9%97%AE%E9%A2%98/Untitled%207.png)

- é€šè¿‡top/chrtæ¥æŸ¥çœ‹è¯¥è¿›ç¨‹å±äºä»€ä¹ˆè¿›ç¨‹
    
    ![Untitled](openmp%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E6%A0%B8%E6%89%93%E6%BB%A1%E7%9A%84%E9%97%AE%E9%A2%98/Untitled%208.png)
    
    éš¾é“è¿™ä¸ªè¿›ç¨‹æ˜¯ä¸€ä¸ªå®æ—¶è¿›ç¨‹ï¼Ÿ
    
    ç»è¿‡ç½‘ä¸ŠæŸ¥é˜…å¾—çŸ¥
    
    - topï¼š
        - å®æ—¶è¿›ç¨‹ï¼šPRç›´æ¥æ˜¾ç¤ºRT
        - æ™®é€šè¿›ç¨‹ï¼š`top_PR = static_Priority - 100`
    
    æ‰€ä»¥ï¼Œæœ¬è¿›ç¨‹åº”è¯¥å±äºæ™®é€šè¿›ç¨‹ï¼Œå¹¶ä¸”æ˜¯é€šè¿‡CFSè°ƒåº¦çš„ï¼ˆé€šè¿‡chrt -på¯ä»¥æŸ¥çœ‹è°ƒåº¦ç­–ç•¥SCHED_NORMALï¼Œå½“ç„¶å› ä¸ºè¿™æœ¬èº«æ˜¯ç”¨æ¥æŸ¥è¯¢å®æ—¶è¿›ç¨‹çš„å‘½ä»¤ï¼Œå› æ­¤æ˜¾ç¤ºçš„ä¼˜å…ˆçº§æ˜¯ä¸å‡†ç¡®çš„ï¼‰
    
    > ä½†åˆ°è¿™é‡Œï¼Œæ„Ÿè§‰è¿™ä¸ªæ€è·¯ä¸å¤ªå¯¹ï¼Œå› ä¸ºæˆ‘ä»¬çš„æœ¬æ„æ˜¯è®©æ¯ä¸ªçº¿ç¨‹ä¸è¦å æ»¡æ¯ä¸ªæ ¸ï¼Œè€Œé€šè¿‡è°ƒåº¦æ¥æ”¹å˜çš„è¯ï¼Œåªèƒ½è°ƒæ•´ä¼˜å…ˆçº§/è°ƒåº¦ç­–ç•¥ï¼Œè¿™æ ·åªä¼šè®©è¿™æ•´ä¸ªè¿›ç¨‹è¢«è°ƒåº¦çš„é¡ºåºå»¶åï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚
    > 

## é™åˆ¶CPUä½¿ç”¨ç‡çš„å·¥å…·

ğŸ› ï¸Â æŸ¥é˜…èµ„æ–™å¾—çŸ¥ï¼Œæ˜¯æœ‰æ¯”è¾ƒç›´ç»™çš„æ–¹å¼ï¼Œå°±æ˜¯ä¸‹é¢ä¸¤ç§å·¥å…·

- cpulimitï¼šå‘é€SIGSTOP å’Œ SIGCONTï¼Œä¸æ–­çš„æš‚åœè¿›ç¨‹ï¼Œä»¥æ§åˆ¶è¿›ç¨‹æ‰€å ç”¨å¤„ç†èƒ½åŠ›ä¸è¶…è¿‡ç‰¹å®šé™åˆ¶
    
    32ä¸ªçº¿ç¨‹æœ€å¤šè·‘32ä¸ªæ ¸ï¼Œæ¯ä¸ªæ ¸é™åˆ¶80%ä½¿ç”¨ç‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º
    
    ![Untitled](openmp%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E6%A0%B8%E6%89%93%E6%BB%A1%E7%9A%84%E9%97%AE%E9%A2%98/Untitled%209.png)
    
    ![ä¸€æ—¦è¶…è¿‡ï¼Œç›´æ¥suspendï¼Œè¿™æ ·æ˜¯ä¸è¡Œçš„](openmp%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E6%A0%B8%E6%89%93%E6%BB%A1%E7%9A%84%E9%97%AE%E9%A2%98/Untitled%2010.png)
    
    ä¸€æ—¦è¶…è¿‡ï¼Œç›´æ¥suspendï¼Œè¿™æ ·æ˜¯ä¸è¡Œçš„
    
- cgroupsï¼šä½¿ç”¨linuxå†…å»ºçš„**control groupsï¼ˆæ§åˆ¶ç»„ï¼‰**åŠŸèƒ½ï¼Œå®ƒæä¾›äº†é™åˆ¶è¿›ç¨‹èµ„æºæ¶ˆè€—çš„æœºåˆ¶ [å¦‚ä½•ä½¿ç”¨](https://www.modb.pro/db/233701) ã€ [cgourpså„ç³»ç»Ÿ](https://blog.csdn.net/weixin_47465999/article/details/130454716)
    - **43.9479ms**
        
        ```cpp
        #include<iostream>
        #include <omp.h>
        #include<unistd.h>
        #include <cstdio>
        using namespace std;
         
        #define openmp
         
        #define M 16384 * 3
        #define N 16384 * 3
         
        static double get_time(struct timespec *start,
                               struct timespec *end) {
            return end->tv_sec - start->tv_sec + (end->tv_nsec - start->tv_nsec) * 1e-9;
        }
         
        int main(){
         
            float x, y, z, factor = 1.1,
                    cx = 2.1, cy = 3.1,
                    fx = 4.1, fy = 5.1;
            
            cpu_set_t mask;
            int cpus = sysconf(_SC_NPROCESSORS_CONF);
            CPU_ZERO(&mask);
            CPU_SET(0, &mask);
        
            #ifdef openmp
            pid_t p = getpid();
            cout<<"pid is "<<p<<endl;
            system("echo 2560000 > /sys/fs/cgroup/cpu/mycgroup/cpu.cfs_quota_us");
            system("echo 100000 > /sys/fs/cgroup/cpu/mycgroup/cpu.cfs_period_us");
            char buffer[80];
            sprintf(buffer, "echo %d > /sys/fs/cgroup/cpu/mycgroup/tasks", p);
            system(buffer);
            #endif
         
            struct timespec start, end;
            double time_tmp;
         
            clock_gettime(CLOCK_MONOTONIC_RAW, &start);
             
            #ifdef openmp
            #pragma omp parallel for num_threads(32)
            #endif
            
            for (int v = 0; v < M * 4; v += 4)
            {
                int threadID = omp_get_thread_num();
                for (int u = 0; u < N * 4; u += 4)
                {
                    float Z = 3.2 / factor;
          
                    z = Z;
                    x = (u - cx) * Z / fx;
                    y = (v - cy) * Z / fy;
          
                    z = z / 1000;
                    x = x / 1000;
                    y = y / 1000;
         
                }
            }
            clock_gettime(CLOCK_MONOTONIC_RAW, &end);
            time_tmp = get_time(&start, &end);
            cout<<"time : "<<time_tmp<<"ms\n";
        }
         
        // ç”±äºè¿è¡Œæ—¶éœ€è¦ä¿®æ”¹cgroupsä¸­çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦åˆ‡æ¢åˆ°rootå†è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæœ€åè¿è¡Œè„šæœ¬
        ```
        
    
    ![Untitled](openmp%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E6%A0%B8%E6%89%93%E6%BB%A1%E7%9A%84%E9%97%AE%E9%A2%98/Untitled%2011.png)
    
    é™åˆ¶åæ¯”èµ·é™åˆ¶å‰å½“ç„¶è€—æ—¶æ˜¯è¦å¢åŠ ï¼Œä½†æ¯”ä¸ä½¿ç”¨openmpè¿˜æ˜¯è¦å¿«å¾ˆå¤šï¼Œæ‰€ä»¥åœ¨å¯æ¥å—èŒƒå›´ä¹‹å†…ï½