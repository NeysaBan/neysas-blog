
---
title: "é€šç”¨çŸ©é˜µä¹˜ä¹‹ä¸ªäººç†è§£"
date: "2023-05-23"
author: "NeysaBan"
category: "cpu"
excerpt: "ä¸ªäººæ€»ç»“çš„é€šç”¨çŸ©é˜µä¹˜çš„é€šç”¨ä¼˜åŒ–ç­–ç•¥+æµ‹è¯•demo"
tags:
- cpu
- simd
- arm
readTime: "8åˆ†é’Ÿ"
---

ä»¥é‡åˆ°çš„ $240 \times 240$ çš„doubleçŸ©é˜µç›¸ä¹˜ä¸ºä¾‹åˆ†æï¼Œè¿™é‡Œå¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œæ„Ÿè§‰ç»´åº¦ä¸ç®—å¤§ï¼Œä¸ºä»€ä¹ˆä¼šæˆä¸ºçƒ­ç‚¹ï¼ŒåŸå› æ˜¯åœ¨å¾ªç¯ä¸­è¿™ä¸ªå‡½æ•°è°ƒç”¨äº†500æ¬¡

# å‚æ•°è®¾ç½®ä¾æ®

### simdå¯„å­˜å™¨é“ºæ»¡ && Cacheé“ºæ»¡ && æµæ°´çº¿æ»¡è½½ çš„tradeoff

1. ä¸ºäº†åŠ é€Ÿå–æ•°ï¼Œä¸€èˆ¬æƒ³è¦æŠŠCacheå’Œsimdå¯„å­˜å™¨é“ºæ»¡ï¼Œä½†è¿™é‡Œæœ‰å¾ˆå¤šè¯´æ³•ï¼Œæˆ‘è®¤åŒä»¥ä¸‹ä¸¤ç‚¹
    1. æ­£åœ¨è®¡ç®—çš„Açš„ $r \times k$ å’ŒBçš„ $k \times c$ ï¼Œä»¥åŠCæœ¬æ¬¡è®¡ç®—å¾—åˆ°çš„ $r \times c$ å—éƒ½åœ¨Cacheå’Œsimdä¸­ä¸­
        1. é“ºæ»¡Cacheä¸­å¾ˆå¥½ç†è§£
            
            ![|549x683](https://20231118-1258904223.cos.ap-shanghai.myqcloud.com/image/202602011758167.png)
            
        2. å¯¹äºéƒ½åœ¨simdä¸­ï¼Œæˆ‘è®¤ä¸ºä¸»è¦æ˜¯ä¸€æ¬¡è®¡ç®—æ—¶ç”¨åˆ°çš„Açš„ä¸€è¡Œã€Bçš„ä¸€åˆ—ä»¥åŠCçš„ä¸­é—´ç»“æœ
            
            ![|478x470](https://20231118-1258904223.cos.ap-shanghai.myqcloud.com/image/202602011758168.png)
            
    2. ä¸ºäº†è®¡ç®—å’Œè®¿å­˜ç›¸äº’æ©ç›–ï¼Œé“ºæ»¡è¿˜è¦è€ƒè™‘é˜²æ­¢æµæ°´çº¿åœé¡¿ï¼Œ
        1. Cacheå’Œå†…å­˜ä¹‹é—´ â†” æœ¬æ¬¡iterå’Œä¸‹æ¬¡iterä¹‹é—´ï¼ˆåœ¨MicroKernelçš„è®¡ç®—ä¸­ï¼Œæ¯æ¬¡ç”¨ä¸€è¡Œã€ä¸€åˆ—ï¼Œè€Œä¸”ç”¨å®Œä¸å†ç”¨ï¼Œå› æ­¤åœ¨æœ¬æ¬¡è®¡ç®—å®Œæ¯•ä¹‹åå°±æ¬ä¸‹ä¸ªiterï¼Œä¸è¿‡å¦‚æœåœ¨MicroKernelä¹‹å¤–çš„é‚£ä¸ªå¾ªç¯ä¹‹å¤–æ‰“åŒ…çŸ©é˜µå°±æœ‰äº›æ— æ³•é‡åŒ–äº†ï¼‰
            1. å†…å­˜loadåˆ°Cacheå‘¨æœŸ < MicroKernelè®¡ç®—å‘¨æœŸï¼šæœ¬æ¬¡iterçš„æ•°æ®é“ºæ»¡Cache
            2. å†…å­˜loadåˆ°Cacheå‘¨æœŸ > MicroKernelè®¡ç®—å‘¨æœŸï¼šæœ¬æ¬¡iteræ•°æ® + ä¸‹æ¬¡iteræ•°æ®é“ºæ»¡Cache
        2. simdå’ŒCacheä¹‹é—´
            
            Cache loadåˆ° simd reg < Açš„ä¸€è¡Œï¼ŒBçš„ä¸€åˆ—çš„è®¡ç®—å‘¨æœŸ
            
    
    <aside>
    ğŸƒ ã€**a.b. çº¦æŸ opt3**ã€‘Cortex A72åªæœ‰L1 Cacheå’Œå…±äº«çš„L2 Cacheï¼Œå¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œä¹Ÿå¯ä»¥ç”¨å‘½ä»¤çœ‹L1 Cacheçš„å¤§å°å’Œ L2Cacheçš„å¤§å°ï¼›å‘¨æœŸå¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£
    
    ç¬”è€…æ˜¯ç”¨çš„Cortex-A72 L1 Cacheä¸­Data Cacheæ˜¯32KBï¼ŒL2ä¸€å…±æ˜¯8MBï¼ˆ16ä¸ªæ ¸åŠ èµ·æ¥ï¼‰ï¼›
    
    simdå¯„å­˜å™¨ä¸€ä¸ª128bit, ä¸€å…±æœ‰32ä¸ªï¼Œ
    
    ä¸€æ¡fmaæŒ‡ä»¤æœ‰7ä¸ªå‘¨æœŸï¼Œä¸€ä¸ªå‘¨æœŸå‘å°„ä¸¤æ¡fmaæŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç†è®ºä¸Šè®²æœ€å¤šåŒæ—¶å¯ä»¥æ‰§è¡Œ14æ¡æŒ‡ä»¤
    
    ä½†ä»simdçš„æŒ‡ä»¤ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæ²¡æœ‰é‚£ç§æ˜ç¡®æŠŠæ•°æ®åŠ è½½åˆ°L1 / L2çš„æŒ‡ä»¤ï¼Œå› æ­¤è¿™ç§å‘¨æœŸæœ‰äº›æ— æ³•ä¼°ç®—ï¼Œæ‰€ä»¥å°±æŠŠè¿™ä¸¤ç§æƒ…å†µä¸‹çš„è®¾ç½®éƒ½è¯•ä¸€ä¸‹
    
    å‡è®¾æ¯æ¬¡è®¡ç®— $r$ è¡Œï¼Œ $c$ åˆ—
    
    1. æœ¬æ¬¡iterçš„æ•°æ®é“ºæ»¡
        - **L2 Cache** $reuse\_less(mï¼Œn) \times k \times 8 Bytes â‰¤ 2^{20} Bytes$
            - å³ $reuse\_less(m, n) â‰¤ 546$
        - **L1 Cache** $reuse\_more(m, n) \times k \times 8Bytes â‰¤ 2^{15} Bytes$
            - å³ $reuse\_more (m, n) â‰¤ 17$
        - **simd Reg** $(m + n + m \times n) \times 8Bytes â‰¤ 32 \times 16Bytes$
            - å³ $m + n + m \times n â‰¤ 64$
    2. æœ¬æ¬¡iter + ä¸‹æ¬¡iteræ•°æ®é“ºæ»¡
        
        å…¶ä½™æ¡ä»¶ä¸å˜
        
        **L2 Cache** å˜æˆ 
        
        $reuse\_less(mï¼Œn) \times k \times 8 Bytes + m \times k + n \times k + m \times n â‰¤ 2^{20} Bytes$ 
        
        å³ $reuse\_less(m, n) * k + m \times k + n \times k + m \times n â‰¤ 1092$ 
        
    
    **âœ¨Ref**
    
    [1] [Raspberry Pi 4 ARM Cortex-A72 processor](http://sandsoftwaresound.net/raspberry-pi-4-arm-cortex-a72-processor/)
    
    [2] [Cortex-A72 Software Optimization Guide Application Note UAN 0016A](https://developer.arm.com/documentation/uan0016/a/?lang=en)
    
    [3] [ä¼˜åŒ–æŒ‡å—æ•°æ®è§£è¯»](https://zhuanlan.zhihu.com/p/517371998#:~:text=%E9%80%9A%E8%BF%87%E6%9F%A5%E9%98%85%20cortex%2Da55%20%E7%9A%84%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97)
    
    [4] [ARMä½“ç³»æ¶æ„](https://zhuanlan.zhihu.com/p/624840889)
    
    [5] [What Every Programmer Should Know About Memory](https://zhuanlan.zhihu.com/p/608663298)
    
    [6] [ARM ç®—å­æ€§èƒ½ä¼˜åŒ–ä¸Šæ‰‹æŒ‡å—](https://blog.51cto.com/u_15847528/5989611#fn7)
    
    [7] [A*ç®—æ³•è¯¦è§£](https://blog.csdn.net/weixin_44489823/article/details/89382502)
    
    </aside>
    

**è¿™é‡Œæœ‰çš„æ—¶å€™æµ‹è¯•ç»“æœä¹Ÿä¸æ˜¯å®Œå…¨ç¬¦åˆç†è®ºï¼Œæ‰€ä»¥æœ€åçš„ç»“è®ºè¿˜éœ€è¦ä»¥ä¸Šçº¦æŸä½œä¸ºæ¡ä»¶å¯å‘å¼æœç´¢å¾—åˆ°ç»“æœ**

### å‚æ•°æœç´¢

ğŸï¸Â **A* ç®—æ³•**

- ä»£ç ä¸­å‡è®¾Aæ”¾åœ¨L2ï¼Œä¹Ÿå°±æ˜¯Aæ˜¯MicroKernelä¸­å¤ç”¨æ›´å°‘çš„é‚£ä¸ªçŸ©é˜µï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯ $reuse\_less(m, n) = m , \\reuse\_more(m, n) = n ,
\\ m >= n$
- å¯ä»¥çœ‹åˆ° $m$ æ¡ä»¶çš„èŒƒå›´å¤ªå¤§ï¼Œå¯ä»¥ç”¨ç¬¬ä¸‰ä¸ªæ¡ä»¶å…ˆé™åˆ¶ä¸€ä¸‹mçš„èŒƒå›´ï¼ˆä»¤ $n = 1$ ï¼‰ï¼Œè¿™æ ·å°±å¤§å¤§å‡å°äº†æœç´¢çš„æ—¶é—´å¤æ‚åº¦

```python
import heapq

solution = 1

## solution ç‹¬æœ‰çš„å˜é‡
if solution == 1:
    m_max = 32
else:
    solution2_target = 1092
## solution å…±äº«çš„å˜é‡
n_max = 17
shared_target = 64

def heuristic(m, n): ## ä»£ä»·å‡½æ•°ï¼Œæ»¡è¶³ç¼“å­˜æ¡ä»¶ä¸‹ï¼Œå¸Œæœ›simdä½¿ç”¨å¾—è¶Šå¤šè¶Šå¥½
    return 64 - (m + n + m * n)

def a_star():
    queue = []
    heapq.heappush(queue, (heuristic(1, 1), 1, 1)) 
    solutions = []
    visited = set()

    while queue: # å¾ªç¯ç›´åˆ°é˜Ÿåˆ—ä¸ºç©º
        h, m, n = heapq.heappop(queue) # å¼¹å‡ºé˜Ÿåˆ—ä¸­ä¼˜å…ˆçº§æœ€é«˜ï¼ˆåœ¨è¿™é‡Œå°±æ˜¯ä»£ä»·æœ€å°ï¼‰çš„å…ƒç´ 
        if (m, n) in visited: # æ£€æŸ¥æ­¤èŠ‚ç‚¹æ˜¯å¦å·²ç»è¢«è®¿é—®è¿‡
            continue # å¦‚æœå·²ç»è®¿é—®è¿‡ï¼Œå°±ä¸ç”¨å¤„ç†è¿™ä¸ªèŠ‚ç‚¹ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªå¾ªç¯
        visited.add((m, n)) # å°†æ­¤èŠ‚ç‚¹æ·»åŠ åˆ°å·²è®¿é—®çš„é›†åˆä¸­

        if m + n + m*n > shared_target: ## simd
            continue

        if m >= n: # æ£€æŸ¥æ­¤èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³ä½ çš„æ¡ä»¶ 
            solutions.append((m,n)) # å¦‚æœæ»¡è¶³æ¡ä»¶å°±æŠŠå®ƒæ·»åŠ åˆ°solutionsä¸­

        if (solution == 1 and m+1 <= m_max) or \
            (solution == 2 and m * 240 + m * 240 + n * 240 + m * n <= solution2_target):  ## L2 Cache
            heapq.heappush(queue, (heuristic(m+1, n), m+1, n)) # æŠŠ(m+1, n)åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­
        if n + 1 <= n_max:
            heapq.heappush(queue, (heuristic(m, n+1), m, n+1)) # æŠŠ(m, n+1)åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­
    return solutions

solutions = a_star()
f = open('log.txt', 'w')  
for t in solutions:
    f.write(str(t) + "\n") 
print(solutions)  
f.close()
```

ğŸ¿ï¸Â **å¹¿åº¦ä¼˜å…ˆæœç´¢éå†**

```python
from collections import deque, defaultdict

solution = 2

## solution ç‹¬æœ‰çš„å˜é‡
if solution == 1:
    m_max = 32
else:
    solution2_target = 1092
## solution å…±äº«çš„å˜é›¶
n_max = 17
shared_target = 64

def bfs():  
    queue = deque([(1, 1)])  
    solutions = defaultdict(int)  
    while queue:  
        m, n = queue.popleft()  
        if m + n + m*n > shared_target: ## simd
            continue  
        if m >= n:
            solutions[(m, n)] += 1
        if (solution == 1 and m+1 <= m_max) or \
            (solution == 2 and m * 240 + m * 240 + n * 240 + m * n <= solution2_target):  ## L2 Cache
            queue.append((m+1, n))  
        if n+1 <= n_max:  ## L1 Cache
            queue.append((m, n+1))  
    return solutions

solutions = bfs() ## solution 1
 
f = open('log.txt', 'w')  
for k, v in solutions.items():
    f.write(str(k) + "\n") 
print(solutions)  
f.close()
```

ğŸ¤«Â **ç»“æœ**

- æœ¬æ¬¡iterçš„æ•°æ®é“ºæ»¡
    
    ```cpp
    ----------- solution 1 -----------
    (1, 1)
    (2, 1)
    (3, 1)
    (2, 2)
    (4, 1)
    (3, 2)
    (5, 1)
    (4, 2)
    (3, 3)
    (6, 1)
    (5, 2)
    (4, 3)
    (7, 1)
    (6, 2)
    (5, 3)
    (4, 4)
    (8, 1)
    (7, 2)
    (6, 3)
    (5, 4)
    (9, 1)
    (8, 2)
    (7, 3)
    (6, 4)
    (5, 5)
    (10, 1)
    (9, 2)
    (8, 3)
    (7, 4)
    (6, 5)
    (11, 1)
    (10, 2)
    (9, 3)
    (8, 4)
    (7, 5)
    (6, 6)
    (12, 1)
    (11, 2)
    (10, 3)
    (9, 4)
    (8, 5)
    (7, 6)
    (13, 1)
    (12, 2)
    (11, 3)
    (10, 4)
    (9, 5)
    (8, 6)
    (7, 7)
    (14, 1)
    (13, 2)
    (12, 3)
    (11, 4)
    (15, 1)
    (14, 2)
    (13, 3)
    (12, 4)
    (16, 1)
    (15, 2)
    (14, 3)
    (17, 1)
    (16, 2)
    (15, 3)
    (18, 1)
    (17, 2)
    (19, 1)
    (18, 2)
    (20, 1)
    (19, 2)
    (21, 1)
    (20, 2)
    (22, 1)
    (23, 1)
    (24, 1)
    (25, 1)
    (26, 1)
    (27, 1)
    (28, 1)
    (29, 1)
    (30, 1)
    (31, 1)
    -------------------------------------
    ```
    
- æœ¬æ¬¡iter + ä¸‹æ¬¡iteræ•°æ®é“ºæ»¡
    
    ```cpp
    ------------- solution 2 --------------
    (1, 1)
    (2, 1)
    (2, 2)
    ---------------------------------------
    ```
    

## Data Pack

- **opt1 [**ç”¨åˆ—å­˜å‚¨è¡Œä¹˜çŸ©é˜µã€ç”¨è¡Œå­˜å‚¨åˆ—ä¹˜çŸ©é˜µ] æ ¹æ®è®¡ç®—ä¸­é—´ç»“æœçš„æ–¹å¼å¾—åˆ°çš„ç­”æ¡ˆ
    
    âœ¨Â Ref
    
    [1] [how-to-optimize-gemm](https://github.com/BBuf/how-to-optimize-gemm)
    
- **opt2** è¿›ä¸€æ­¥ä¼˜åŒ–çš„è¯ï¼Œå°±æ˜¯å†åˆ†å—æ‰“åŒ…ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚æ˜¯æŒ‰ç…§8x6åˆ†å—è®¡ç®—çŸ©é˜µï¼Œé‚£ä¹ˆè¡Œä¹˜çŸ©é˜µæŒ‰åˆ—å­˜å‚¨åï¼Œå†æ¯8åˆ—æ‰“åŒ…åˆ°ä¸€èµ·ã€‚è¿™å°±è¿›ä¸€æ­¥å‡å°äº†cache miss
    
    [1] [åŸºäºARM-v8çš„Tengine GEMMæ•™ç¨‹](https://github.com/lyuchuny3/Tengine_gemm_tutorial/blob/master/readme_cn.md#gemm%E7%AE%80%E4%BB%8B)
    
    ![](https://20231118-1258904223.cos.ap-shanghai.myqcloud.com/image/202602011758169.png)
    

<aside>
ğŸƒ **Attention** âš ï¸

Aã€Bæ‰“åŒ…è¦åœ¨å¯¹åº”çš„è¡Œã€åˆ—ç”¨åˆ°æ—¶å†æ‰“åŒ…ï¼Œè¿™æ ·ä¼šæ›´èŠ‚çœå†…å­˜è®¿é—®æ—¶é—´

</aside>

# æµ‹è¯•ç¯å¢ƒ

- ç¡¬ä»¶ï¼š
    - Cortex-A72ï¼ˆ`lscpu | grep "Model nameâ€`ï¼‰
- çŸ©é˜µç±»å‹ï¼šåŒç²¾åº¦æµ®ç‚¹å‹ï¼Œä¸¤ä¸ªçŸ©é˜µè¡Œåˆ—ç»´åº¦éƒ½æ˜¯240ï¼ˆä¹Ÿå¯ä»¥æµ‹è¯•åˆ«çš„ç»´åº¦ï¼Œä½†æµ‹è¯•demoä»…é€‚ç”¨äºMã€Nã€Kæ˜¯6ã€8å…¬å€æ•°çš„æƒ…å†µï¼‰ï¼Œåˆ—ä¸»åºï¼Œä¸€ç»´å­˜å‚¨
- ä¼˜åŒ–ç­–ç•¥ï¼šä»…é’ˆå¯¹çŸ©é˜µåˆ†å—ï¼Œä½¿ç”¨SIMDï¼Œä¸æµ‹è¯•å…¶ä»–ä¼˜åŒ–ç­–ç•¥

# ğŸ‘»Â ç¨‹åºæ€§èƒ½ç ”ç©¶

## 1ã€GFlops

githubä¸Šä¸€äº›çŸ©é˜µä¹˜æ³•æ˜¯ç”¨GFlopsçœ‹è‡ªå·±çš„ç®—æ³•æ˜¯å¦è¾¾åˆ°æé™ï¼Œè¿™é‡Œä¹Ÿé‡‡ç”¨ç›¸åŒçš„åŠæ³•

### è‡ªå·±è®¡ç®—

- æµæ°´çº¿æ’å¸ƒï¼ˆç†æƒ³æƒ…å†µä¸‹ï¼Œä¸€ä¸ªcycleè¾¾åˆ°ä¸€æ¡mulå’Œä¸€æ¡addçš„ç»ˆç‚¹ï¼‰ï¼š(1 mul + 1 add) / cycle
- NEONï¼š2 double ops at once
- frequencyï¼šmin 900MHz ~ max 2200 MHz
    - `lscpu`
        
        ```python
        root@lx2160ardb-rev2:~# lscpu
        Architecture:                    aarch64
        CPU op-mode(s):                  32-bit, 64-bit ## CPU æ“ä½œæ¨¡å¼ï¼Œè¿™é‡Œçš„ 32-bit, 64-bit è¡¨ç¤º CPU æ—¢å¯ä»¥ä»¥ 32 ä½æ¨¡å¼è¿è¡Œï¼Œä¹Ÿå¯ä»¥ä»¥ 64 ä½æ¨¡å¼è¿è¡Œ
        Byte Order:                      Little Endian ## å°ç«¯çš„å­—èŠ‚åº
        CPU(s):                          16 ## 16 ä¸ªé€»è¾‘CPU
        On-line CPU(s) list:             0-15 
        Thread(s) per core:              1 ## æ¯ä¸ªæ ¸å¿ƒçš„çº¿ç¨‹æ•°ï¼Œè¿™é‡Œå†™çš„ 1 è¯´æ˜è¯¥ CPU ä¸æ”¯æŒè¶…çº¿ç¨‹
        Core(s) per socket:              16 ## æ¯ä¸ªç‰©ç†cpuä¸Šçš„æ ¸å¿ƒæ•°ï¼Œè¯¥ç³»ç»Ÿä¸Šä¸€å…±æœ‰ 16 ä¸ªæ ¸å¿ƒ
        Socket(s):                       1 ## ç‰©ç†å¤„ç†å™¨çš„æ•°é‡ï¼Œè¿™é‡Œ 1 æ„å‘³ç€æˆ‘ä»¬æœ‰ä¸€ä¸ªç‰©ç†å¤„ç†å™¨
        NUMA node(s):                    1 ## å¤„ç†å†…å­˜è®¿é—®çš„ NUMA èŠ‚ç‚¹æ•°
        Vendor ID:                       ARM
        Model:                           3
        Model name:                      Cortex-A72
        Stepping:                        r0p3 ## r0p3 æ˜¯è¯¥ CPU ç‰¹å®šçš„äº§å“ç‰ˆæœ¬å’Œä¿®è®¢å·
        CPU max MHz:                     2200.0000
        CPU min MHz:                     900.0000
        BogoMIPS:                        50.00 ## ä¸€é¡¹æ—©æœŸç”¨äºå¤§è‡´è¯„ä¼° CPU é€Ÿåº¦çš„æŒ‡æ ‡ï¼Œè¿™é‡Œçš„ 50.00 æŒ‡æ¯ç§’å¯æ‰§è¡Œ 50,000,000 ä¸ªæ— ç”¨æ“ä½œ
        L1d cache:                       512 KiB
        L1i cache:                       768 KiB
        L2 cache:                        8 MiB
        NUMA node0 CPU(s):               0-15
        Vulnerability Itlb multihit:     Not affected
        Vulnerability L1tf:              Not affected
        Vulnerability Mds:               Not affected
        Vulnerability Meltdown:          Not affected
        Vulnerability Spec store bypass: Not affected
        Vulnerability Spectre v1:        Mitigation; __user pointer sanitization
        Vulnerability Spectre v2:        Mitigation; Branch predictor hardening
        Vulnerability Srbds:             Not affected
        Vulnerability Tsx async abort:   Not affected
        Flags:                           fp asimd evtstrm aes pmull sha1 sha2 crc32 cpuid
        ```
        
- peak performaceï¼š8800 MFlops  = 8.59 GFlops (for 1 core)

### å€ŸåŠ©å·¥å…·

ä¸ºä»€ä¹ˆå€ŸåŠ©å·¥å…·ï¼š

å› ä¸ºè€ƒè™‘åˆ°cpué¢‘ç‡æ³¢åŠ¨ã€ä¸åŒæ ¸äº‰ç”¨å…±äº«å†…å­˜ç­‰æƒ…å†µï¼Œæ‰€ä»¥æƒ³çœ‹ä¸‹å®é™…æƒ…å†µæœ€é«˜èƒ½åˆ°å¤šå°‘

**âœ¨Ref**

[1] [**æµ®ç‚¹å³°å€¼é‚£äº›äº‹å„¿**](https://zhuanlan.zhihu.com/p/28226956)

[2] [**å€ŸåŠ© mperf è¿›è¡ŒçŸ©é˜µä¹˜æ³•æè‡´ä¼˜åŒ–**](https://zhuanlan.zhihu.com/p/617285203)

[3] https://github.com/MegEngine/MegPeak // ä½¿ç”¨çš„æµ®ç‚¹å³°å€¼åˆ†æå·¥å…·

- MegPeak ä½¿ç”¨ï¼ˆå¹³å°x86ï¼Œç›®æ ‡å¹³å°armv8aï¼‰
    - CMakeLists.txt
        
        ```python
        cmake_minimum_required(VERSION 3.15.2)
        set(CMAKE_EXPORT_COMPILE_COMMANDS ON CACHE INTERNAL "")
        
        project(MegEngine LANGUAGES C CXX ASM)
        set(CMAKE_CXX_STANDARD 14)
        
        message(${PROJECT_SOURCE_DIR})
        message(${CMAKE_CURRENT_SOURCE_DIR})
        
        option(MEGPEAK_ENABLE_OPENCL "Build MegPeak with OpenCL." OFF)
        option(MEGPEAK_ENABLE_ALL_BENCHMARK "Build MegPeak with all benchmark." OFF)
        option(MEGPEAK_USE_CPUINFO   "Use cpuinfo library"        OFF)
        option(MEGPEAK_ENABLE_DOT       "Use arm dotprod instruction."   OFF)
        option(MEGPEAK_ENABLE_MMA       "Use arm mma instruction"        OFF)
        
        # if(CMAKE_TOOLCHAIN_FILE)
        #     message(STATUS "cross compile MegPeak.")
        #     if(ANDROID_TOOLCHAIN_ROOT)
        #         if(NOT "${ANDROID_ARCH_NAME}" STREQUAL "")
        #             set(ANDROID_ARCH ${ANDROID_ARCH_NAME})
        #         endif()
        #         if(${ANDROID_ARCH} STREQUAL "arm")
        #             set(MGEPEAK_ARCH "armv7")
        #         elseif(${ANDROID_ARCH} STREQUAL "arm64")
        #             set(MGEPEAK_ARCH "aarch64")
        #         else()
        #             message(FATAL_ERROR "DO NOT SUPPORT ANDROID ARCH NOW")
        #         endif()
        #     elseif(NOT "${ARM_CROSS_BUILD_ARCH}" STREQUAL "")
        #         set(MGEPEAK_ARCH ${ARM_CROSS_BUILD_ARCH})
        #     else()
        #         message(FATAL_ERROR "Unknown cross-compiling settings.")
        #     endif()
        # else()
        #     message("CMAKE SYSTEM PROCESSOR :${CMAKE_SYSTEM_PROCESSOR}.")
        #     if(${CMAKE_SYSTEM_PROCESSOR} MATCHES "x86_64")
        #         set(MGEPEAK_ARCH "x86")
        #     else()
        #         set(MGEPEAK_ARCH "aarch64")
        #     endif()
        # endif()
        
        set(MGEPEAK_ARCH "aarch64")
        
        message(STATUS "CONFIG MGEPEAK_ARCH TO ${MGEPEAK_ARCH}")
        
        file(GLOB_RECURSE SRC src/*.cpp src/*.h )
        
        add_executable(megpeak ${SRC})
        target_include_directories(megpeak PUBLIC ${PROJECT_SOURCE_DIR})
        
        set(CMAKE_CXX_FLAGS "-Ofast -g ${CMAKE_CXX_FLAGS}")
        if(${MGEPEAK_ARCH} STREQUAL "aarch64")
            set(CMAKE_CXX_FLAGS " -DMEGPEAK_AARCH64=1 ${CMAKE_CXX_FLAGS}")
        elseif(${MGEPEAK_ARCH} STREQUAL "armv7")
            set(CMAKE_CXX_FLAGS " -DMEGPEAK_ARMV7=1 ${CMAKE_CXX_FLAGS}")
        elseif(${MGEPEAK_ARCH} STREQUAL "x86")
            set(CMAKE_CXX_FLAGS " -DMEGPEAK_X86=1 ${CMAKE_CXX_FLAGS}")
        else()
            message(FATAL_ERROR "Unknown MEGPEAK_ARCH ${MEGPEAK_ARCH}.")
        endif()
        
        if(MEGPEAK_ENABLE_DOT)
            message(STATUS "Enable dotprod feature in armv8.2-a")
            set(CMAKE_CXX_FLAGS " -march=armv8.2-a+dotprod ${CMAKE_CXX_FLAGS}")
        endif()
        if(MEGPEAK_ENABLE_MMA)
            message(STATUS "Enable smmla feature in armv8.6-a")
            set(CMAKE_CXX_FLAGS " -march=armv8.6-a ${CMAKE_CXX_FLAGS}")
        endif()
        
        if(MEGPEAK_ENABLE_OPENCL)
            set(CMAKE_CXX_FLAGS " -DMEGPEAK_WITH_OPENCL=1 ${CMAKE_CXX_FLAGS}")
        
            message(STATUS "megpeak build with opencl.")
            add_subdirectory(opencl-stub)
            target_include_directories(megpeak PUBLIC ${PROJECT_SOURCE_DIR}/opencl-stub/include/)
            target_link_libraries(megpeak OpenCL)
        endif()
        
        if(MEGPEAK_ENABLE_ALL_BENCHMARK)
            set(CMAKE_CXX_FLAGS " -DMEGPEAK_WITH_ALL_BENCHMARK=1 ${CMAKE_CXX_FLAGS}")
            message(STATUS "megpeak build with all benchmark.")
        endif()
        
        if(UNIX)
            target_link_libraries(megpeak dl)
        endif()
        if(ANDROID)
            target_link_libraries(megpeak log)
        endif()
        
        if(MEGPEAK_USE_CPUINFO)
            add_definitions(-DMEGPEAK_USE_CPUINFO)
            set(CPUINFO_BUILD_UNIT_TESTS OFF CACHE BOOL "")
            set(CPUINFO_BUILD_MOCK_TESTS OFF CACHE BOOL "")
            set(CPUINFO_BUILD_BENCHMARKS OFF CACHE BOOL "")
            add_subdirectory(cpuinfo)
            target_link_libraries(megpeak cpuinfo::cpuinfo)
        endif()
        ```
        
    - è¦æŠŠäº¤å‰ç¼–è¯‘çš„å·¥å…·é“¾æ”¾åˆ°å·¥ä½œç›®å½•ä¸‹
        
        ![](https://20231118-1258904223.cos.ap-shanghai.myqcloud.com/image/202602011758170.png)
        
    - ç¼–è¯‘å‘½ä»¤ `cmake -DCMAKE_TOOLCHAIN_FILE=../arm-gcc-toolchain.cmake .. && make`

æµ‹è¯•ç»“æœ17.5847GFlops / 2 = 8.792GFlops

![](https://20231118-1258904223.cos.ap-shanghai.myqcloud.com/image/202602011758171.png)

## 2ã€perf

âœ¨Â Ref

[1] [Perf -- Linuxä¸‹çš„ç³»ç»Ÿæ€§èƒ½è°ƒä¼˜å·¥å…·](https://blog.51cto.com/u_15715098/5954226) : perfåŸç†ã€ä¸‰ç±»äº‹ä»¶(hardware/software/tracepoint)æ¥æºã€ä½¿ç”¨æ–¹æ³•ã€æ”¯æŒçš„å…·ä½“äº‹ä»¶çš„å«ä¹‰

[2] [äººäººéƒ½åº”è¯¥çŸ¥é“çš„CPUç¼“å­˜è¿è¡Œæ•ˆç‡](http://www.360doc.com/content/23/0602/08/1083164807_1083164807.shtml) ï¼šç»•è¿‡å°è£…å¥½çš„perfä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ¥è·å–æ€§èƒ½æŒ‡æ ‡ã€perfå†…éƒ¨å·¥ä½œåŸç†ï¼ˆPMCå¯„å­˜å™¨ï¼ŒPMUæ¨¡å—ï¼‰

[3] [SPE profilingåŠå…¶ä½¿ç”¨](https://aijishu.com/a/1060000000398832) ï¼šPMUå±€é™æ€§ã€å¦‚ä½•ä½¿ç”¨SPE

[4] [perf_eventæ¡†æ¶ä¹‹ï¼šARM PMUç¡¬ä»¶](https://zhuanlan.zhihu.com/p/276680818) ï¼šPMUäº‹ä»¶è®¡æ•°å™¨ï¼ˆä¸€ä¸ªcycle counterï¼Œnä¸ªperformance counterï¼Œoverflowä¹‹åå‘ç”Ÿä¸­æ–­é€šçŸ¥cpuï¼‰+ æ“ä½œè¿™äº›æŠ€æœ¯å™¨çš„æ§åˆ¶å¯„å­˜å™¨ï¼ˆæè¿°/æ§åˆ¶ç³»ç»ŸPMUèµ„æºã€é…ç½®è®¡æ•°å™¨ã€è®¿é—®è®¡æ•°å™¨ï¼‰

- `perf list` æŸ¥çœ‹æ”¯æŒçš„äº‹ä»¶
    
    ```python
    
    List of pre-defined events (to be used in -e):
    
      branch-misses                                      [Hardware event]
      bus-cycles                                         [Hardware event]
      cache-misses                                       [Hardware event]
      cache-references                                   [Hardware event]
      cpu-cycles OR cycles                               [Hardware event]
      instructions                                       [Hardware event]
    
      alignment-faults                                   [Software event]
      bpf-output                                         [Software event]
      context-switches OR cs                             [Software event]
      cpu-clock                                          [Software event]
      cpu-migrations OR migrations                       [Software event]
      dummy                                              [Software event]
      emulation-faults                                   [Software event]
      major-faults                                       [Software event]
      minor-faults                                       [Software event]
      page-faults OR faults                              [Software event]
      task-clock                                         [Software event]
    
      duration_time                                      [Tool event]
    
      L1-dcache-load-misses                              [Hardware cache event]
      L1-dcache-loads                                    [Hardware cache event]
      L1-dcache-store-misses                             [Hardware cache event]
      L1-dcache-stores                                   [Hardware cache event]
      L1-icache-load-misses                              [Hardware cache event]
      L1-icache-loads                                    [Hardware cache event]
      branch-load-misses                                 [Hardware cache event]
      branch-loads                                       [Hardware cache event]
      dTLB-load-misses                                   [Hardware cache event]
      dTLB-store-misses                                  [Hardware cache event]
      iTLB-load-misses                                   [Hardware cache event]
      node-loads                                         [Hardware cache event]
      node-stores                                        [Hardware cache event]
    
      br_mis_pred OR armv8_cortex_a72/br_mis_pred/       [Kernel PMU event]
      br_pred OR armv8_cortex_a72/br_pred/               [Kernel PMU event]
      bus_access OR armv8_cortex_a72/bus_access/         [Kernel PMU event]
      bus_cycles OR armv8_cortex_a72/bus_cycles/         [Kernel PMU event]
      cid_write_retired OR armv8_cortex_a72/cid_write_retired/ [Kernel PMU event]
      cpu_cycles OR armv8_cortex_a72/cpu_cycles/         [Kernel PMU event]
      exc_return OR armv8_cortex_a72/exc_return/         [Kernel PMU event]
      exc_taken OR armv8_cortex_a72/exc_taken/           [Kernel PMU event]
      inst_retired OR armv8_cortex_a72/inst_retired/     [Kernel PMU event]
      inst_spec OR armv8_cortex_a72/inst_spec/           [Kernel PMU event]
      l1d_cache OR armv8_cortex_a72/l1d_cache/           [Kernel PMU event]
      l1d_cache_refill OR armv8_cortex_a72/l1d_cache_refill/ [Kernel PMU event]
      l1d_cache_wb OR armv8_cortex_a72/l1d_cache_wb/     [Kernel PMU event]
      l1d_tlb_refill OR armv8_cortex_a72/l1d_tlb_refill/ [Kernel PMU event]
      l1i_cache OR armv8_cortex_a72/l1i_cache/           [Kernel PMU event]
      l1i_cache_refill OR armv8_cortex_a72/l1i_cache_refill/ [Kernel PMU event]
      l1i_tlb_refill OR armv8_cortex_a72/l1i_tlb_refill/ [Kernel PMU event]
      l2d_cache OR armv8_cortex_a72/l2d_cache/           [Kernel PMU event]
      l2d_cache_refill OR armv8_cortex_a72/l2d_cache_refill/ [Kernel PMU event]
      l2d_cache_wb OR armv8_cortex_a72/l2d_cache_wb/     [Kernel PMU event]
    ```
    

```cpp
perf stat -e L1-dcache-load-misses,L1-dcache-loads,l1d_cache,l1d_cache_refill,l2d_cache,l2d_cache_refill,cache-misses,cpu-cycles ./matrix_test
perf report // çœ‹å…·ä½“ç»†èŠ‚
```

# ğŸ²Â ç»“æœ

## GFlops

|  | GFlops_Percent |  GFlops |
| --- | --- | --- |
| *PureMultiply* | 7.85% | 0.69 |
| *Seg1x4Multiply* | 22.6% | 1.99 |
| *Seg1x8Multiply* | 18.4% | 1.62 |
| *Seg1x16Multiply* | 19.2% | 1.69 |
| *Seg2x4Multiply* | 32.87% | 2.89 |
| *Seg8x6Multiply* | 43.8% | 3.85 |
| *Interval_Seg8x6Multiply* | 60.5% | 5.32 |

## perf

- pure
    
    ```python
    root@lx2160ardb-rev2:~/xinru# perf stat -e L1-dcache-load-misses,L1-dcache-loads,l1d_cache,l1d_cache_refill,l2d_cache,l2d_cache_refill,cache-misses,cpu-cycles ./matrix_test
    PureMultiply: 
    time_cost: 0.0295961, gflops : 0.934177
    --------------------------------------
    
     Performance counter stats for './matrix_test':
    
               6423372      L1-dcache-load-misses     #   19.63% of all L1-dcache accesses  (84.05%)
              32719684      L1-dcache-loads                                               (89.28%)
              32681012      l1d_cache                                                     (89.26%)
               5556385      l1d_cache_refill                                              (89.26%)
              12520149      l2d_cache                                                     (89.28%)
                 72888      l2d_cache_refill                                              (89.26%)
               5949163      cache-misses                                                  (69.62%)
              81707180      cpu-cycles                                                    (80.37%)
    
           0.037875524 seconds time elapsed
    
           0.037947000 seconds user
           0.000000000 seconds sys
    ```
    
- 1 x 4
    
    ```python
    Seg1x4Multiply: 
    time_cost: 0.0138934, gflops : 1.99001
    --------------------------------------
    
     Performance counter stats for './matrix_test':
    
               1621501      L1-dcache-load-misses     #    7.45% of all L1-dcache accesses  (81.64%)
              21768607      L1-dcache-loads                                               (81.87%)
              21517046      l1d_cache                                                     (81.57%)
               1184375      l1d_cache_refill                                              (81.57%)
               4042985      l2d_cache                                                     (89.03%)
                103134      l2d_cache_refill                                            
               1541671      cache-misses                                                  (84.32%)
              47492053      cpu-cycles                                                    (84.32%)
    
           0.022352035 seconds time elapsed
    
           0.022325000 seconds user
           0.000000000 seconds sys
    ```
    
- 1 x 8
    
    ```python
    Seg1x8Multiply: 
    time_cost: 0.0171028, gflops : 1.61658
    --------------------------------------
    
     Performance counter stats for './matrix_test':
    
               2245441      L1-dcache-load-misses     #   16.72% of all L1-dcache accesses  (84.04%)
              13428095      L1-dcache-loads                                               (83.98%)
              13460030      l1d_cache                                                     (83.97%)
               1750939      l1d_cache_refill                                              (83.94%)
               4004592      l2d_cache                                                     (83.99%)
                 90691      l2d_cache_refill                                              (93.66%)
               2155767      cache-misses                                                  (86.42%)
              54673289      cpu-cycles                                                    (86.42%)
    
           0.025498709 seconds time elapsed
    
           0.025553000 seconds user
           0.000000000 seconds sys
    ```
    
- 1 x 16
    
    ```python
    root@lx2160ardb-rev2:~/xinru# perf stat -e L1-dcache-load-misses,L1-dcache-loads,l1d_cache,l1d_cache_refill,l2d_cache,l2d_cache_refill,cache-misses,cpu-cycles ./matrix_test
    Seg1x16Multiply: 
    time_cost: 0.0163398, gflops : 1.69206
    --------------------------------------
    
     Performance counter stats for './matrix_test':
    
               2245109      L1-dcache-load-misses     #   11.53% of all L1-dcache accesses  (83.52%)
              19474065      L1-dcache-loads                                               (83.43%)
              19369501      l1d_cache                                                     (83.47%)
               1721986      l1d_cache_refill                                              (83.41%)
               3747666      l2d_cache                                                     (83.53%)
                 72762      l2d_cache_refill                                              (96.73%)
               2155232      cache-misses                                                  (85.91%)
              52906271      cpu-cycles                                                    (85.91%)
    
           0.024707111 seconds time elapsed
    
           0.020643000 seconds user
           0.004111000 seconds sys
    ```
    
- 2 x 4
    
    ```python
    root@lx2160ardb-rev2:~/xinru# perf stat -e L1-dcache-load-misses,L1-dcache-loads,l1d_cache,l1d_cache_refill,l2d_cache,l2d_cache_refill,cache-misses,cpu-cycles ./matrix_test
    Seg2x4Multiply: 
    time_cost: 0.00896442, gflops : 3.08419
    --------------------------------------
    
     Performance counter stats for './matrix_test':
    
                963736      L1-dcache-load-misses     #    6.66% of all L1-dcache accesses  (76.13%)
              14471122      L1-dcache-loads                                               (76.05%)
              14340631      l1d_cache                                                     (76.03%)
                732050      l1d_cache_refill                                              (92.27%)
               2257839      l2d_cache                                                   
                 78231      l2d_cache_refill                                            
                892526      cache-misses                                                  (79.52%)
              36483935      cpu-cycles                                                    (79.52%)
    
           0.017301886 seconds time elapsed
    
           0.017424000 seconds user
           0.000000000 seconds sys
    ```
    
- 8 x 6
    
    ```python
    root@lx2160ardb-rev2:~/xinru# perf stat -e L1-dcache-load-misses,L1-dcache-loads,l1d_cache,l1d_cache_refill,l2d_cache,l2d_cache_refill,cache-misses,cpu-cycles ./matrix_test
    Seg8x6Multiply: 
    time_cost: 0.00696611, gflops : 3.96893
    --------------------------------------
    
     Performance counter stats for './matrix_test':
    
               1335848      L1-dcache-load-misses     #   15.42% of all L1-dcache accesses  (73.41%)
               8664208      L1-dcache-loads                                               (73.34%)
               8733488      l1d_cache                                                     (75.15%)
                994107      l1d_cache_refill                                            
               2271769      l2d_cache                                                   
                 72222      l2d_cache_refill                                            
               1215666      cache-misses                                                  (78.10%)
              32822963      cpu-cycles                                                    (78.10%)
    
           0.015720889 seconds time elapsed
    
           0.015805000 seconds user
           0.000000000 seconds sys
    ```
    
- Interval 8 x 6
    
    ```python
    root@lx2160ardb-rev2:~/xinru# perf stat -e L1-dcache-load-misses,L1-dcache-loads,l1d_cache,l1d_cache_refill,l2d_cache,l2d_cache_refill,cache-misses,cpu-cycles ./matrix_test
    Interval_Seg8x6Multiply: 
    time_cost: 0.00503983, gflops : 5.4859
    --------------------------------------
    
     Performance counter stats for './matrix_test':
    
                183098      L1-dcache-load-misses     #    2.21% of all L1-dcache accesses  (68.91%)
               8268315      L1-dcache-loads                                               (68.82%)
               7946663      l1d_cache                                                     (88.52%)
                143123      l1d_cache_refill                                            
               1025510      l2d_cache                                                   
                 86594      l2d_cache_refill                                            
                142331      cache-misses                                                  (73.75%)
              28078672      cpu-cycles                                                    (73.75%)
    
           0.013350693 seconds time elapsed
    
           0.008991000 seconds user
           0.004478000 seconds sys
    ```
    

# ğŸ‡Â ä»£ç 

- *PureMultiply*
    
    ```cpp
    void PureMultiply(double *a, double *b, double *c, int m, int k, int n)
    {
        for (int i = 0; i < m; i++)
        {
            for (int j = 0; j < n; j++)
            {
                double tmp = 0.0;
                for (int t = 0; t < k; t++)
                {
                    tmp += a[i + t * m] * b[t + j * k];
                }
                c[i * n + j] = tmp;
            }
        }
    }
    ```
    
- *Seg1x4Multiply*
    
    ```cpp
    void Seg1x4(int k, double *a, const double *b, double *c){
        // aä¸€è¡Œ x bå…«åˆ—
        double *a_cur = a;
        const double *b_i0_cur = b, *b_i1_cur = b + 1*k , *b_i2_cur = b + 2*k , *b_i3_cur = b + 3*k;
     
        float64x2_t res_i01 = {0}, res_i23 = {0};
     
        for(int i = 0 ; i < k ; i ++){
            float64_t a_reg = *(a_cur);
            float64x2_t b_i01_reg,  // ä¸€æ¬¡ç«–ç€åŠ è½½ä¸€ä¸ªæ•°
                        b_i23_reg;
     
            b_i01_reg = vld1q_lane_f64(b_i0_cur, b_i01_reg, 0);
            b_i01_reg = vld1q_lane_f64(b_i1_cur, b_i01_reg, 1);
            b_i23_reg = vld1q_lane_f64(b_i2_cur, b_i23_reg, 0);
            b_i23_reg = vld1q_lane_f64(b_i3_cur, b_i23_reg, 1);
     
            res_i01 = vfmaq_n_f64(res_i01, b_i01_reg, a_reg);
            res_i23 = vfmaq_n_f64(res_i23, b_i23_reg, a_reg);
     
            a_cur ++;
            b_i0_cur ++;
            b_i1_cur ++;
            b_i2_cur ++;
            b_i3_cur ++;
        }
        vst1q_f64(c,   res_i01);
        vst1q_f64(c+2, res_i23);
    }
    
    void Seg1x4Multiply(double *a, double *b, double *c, int m, int k, int n)
    {
        cout<<"Seg1x4Multiply: \n";
        Transpose(a, m, k);
        double *a_cur = a, *b_cur, *c_cur = c;
        long long int i, j;
        for (i = 0; i < m; i += 1, a_cur += 1 * k, c_cur += 1 * n)
        {
            b_cur = b;
            for (j = 0; j < n; j += 4, b_cur += 4 * k)
            {
                Seg1x4(k, a_cur, b_cur, c_cur + j);
            }
        }
    }
    ```
    
- Seg1x8Multiply
    
    ```cpp
    void Seg1x8(int k, double *a, const double *b, double *c){
        // æ‰€ä»¥åº”è¯¥æ˜¯açš„ä¸€è¡Œ x bçš„å…«åˆ—
        float64_t resi0 = {0}; // (row, 0)
        float64_t resi1 = {0}; // (row, 1)
        float64_t resi2 = {0}; // (row, 2)
        float64_t resi3 = {0}; // (row, 3)
        float64_t resi4 = {0};
        float64_t resi5 = {0};
        float64_t resi6 = {0};
        float64_t resi7 = {0};
         
        double *a_cur = a;
        const double *b_i0_cur = b, *b_i1_cur = b + 1*k , *b_i2_cur = b + 2*k , *b_i3_cur = b + 3*k,
                *b_i4_cur = b + 4*k, *b_i5_cur = b + 5*k , *b_i6_cur = b + 6*k , *b_i7_cur = b + 7*k;
     
        for(int i = 0 ; i < k ; i += 2){
            float64x2_t a_reg = vld1q_f64(a_cur);   // ä¸€æ¬¡æ¨ªç€åŠ è½½ä¸¤ä¸ªæ•°
            float64x2_t b_i0_reg = vld1q_f64(b_i0_cur),  // ä¸€æ¬¡ç«–ç€åŠ è½½ä¸¤ä¸ªæ•°
                        b_i1_reg = vld1q_f64(b_i1_cur),
                        b_i2_reg = vld1q_f64(b_i2_cur),
                        b_i3_reg = vld1q_f64(b_i3_cur),
                        b_i4_reg = vld1q_f64(b_i4_cur),
                        b_i5_reg = vld1q_f64(b_i5_cur),
                        b_i6_reg = vld1q_f64(b_i6_cur),
                        b_i7_reg = vld1q_f64(b_i7_cur);
     
     
            resi0 += (a_reg[0]*b_i0_reg[0] + a_reg[1]*b_i0_reg[1]);
            resi1 += (a_reg[0]*b_i1_reg[0] + a_reg[1]*b_i1_reg[1]);
            resi2 += (a_reg[0]*b_i2_reg[0] + a_reg[1]*b_i2_reg[1]);
            resi3 += (a_reg[0]*b_i3_reg[0] + a_reg[1]*b_i3_reg[1]);
            resi4 += (a_reg[0]*b_i4_reg[0] + a_reg[1]*b_i4_reg[1]);
            resi5 += (a_reg[0]*b_i5_reg[0] + a_reg[1]*b_i5_reg[1]);
            resi6 += (a_reg[0]*b_i6_reg[0] + a_reg[1]*b_i6_reg[1]);
            resi7 += (a_reg[0]*b_i7_reg[0] + a_reg[1]*b_i7_reg[1]);
     
            a_cur += 2;
            b_i0_cur += 2;
            b_i1_cur += 2;
            b_i2_cur += 2;
            b_i3_cur += 2;
            b_i4_cur += 2;
            b_i5_cur += 2;
            b_i6_cur += 2;
            b_i7_cur += 2;
        }
     
        *(c ) = resi0;
        *(c + 1) = resi1;
        *(c + 2) = resi2;
        *(c + 3) = resi3;
        *(c + 4) = resi4;
        *(c + 5) = resi5;
        *(c + 6) = resi6;
        *(c + 7) = resi7;
    }
    
    void Seg1x8Multiply(double *a, double *b, double *c, int m, int k, int n)
    {
        cout<<"Seg1x8Multiply: \n";
        Transpose(a, m, k);
        double *a_cur = a, *b_cur, *c_cur = c;
        long long int i, j;
        for (i = 0; i < m; i += 1, a_cur += 1 * k, c_cur += 1 * n)
        {
            b_cur = b;
            for (j = 0; j < n; j += 8, b_cur += 8 * k)
            {
                Seg1x8(k, a_cur, b_cur, c_cur + j);
            }
        }
    }
    
    ```
    
- Seg1x16Multiply
    
    ```cpp
    void Seg1x16(int k, double *a, const double *b, double *c)
    {
        // æ‰€ä»¥åº”è¯¥æ˜¯açš„ä¸€è¡Œ x bçš„å…«åˆ—
        float64_t resi0 = {0}; // (row, 0)
        float64_t resi1 = {0}; // (row, 1)
        float64_t resi2 = {0}; // (row, 2)
        float64_t resi3 = {0}; // (row, 3)
        float64_t resi4 = {0};
        float64_t resi5 = {0};
        float64_t resi6 = {0};
        float64_t resi7 = {0};
        float64_t resi8 = {0};
        float64_t resi9 = {0};
        float64_t resi10 = {0};
        float64_t resi11 = {0};
        float64_t resi12 = {0};
        float64_t resi13 = {0};
        float64_t resi14 = {0};
        float64_t resi15 = {0};
     
        double *a_cur = a;
        const double *b_i0_cur = b, *b_i1_cur = b + 1 * k, *b_i2_cur = b + 2 * k, *b_i3_cur = b + 3 * k,
                     *b_i4_cur = b + 4 * k, *b_i5_cur = b + 5 * k, *b_i6_cur = b + 6 * k, *b_i7_cur = b + 7 * k,
                     *b_i8_cur = b + 8 * k, *b_i9_cur = b + 9 * k, *b_i10_cur = b + 10 * k, *b_i11_cur = b + 11 * k,
                     *b_i12_cur = b + 12 * k, *b_i13_cur = b + 13 * k, *b_i14_cur = b + 14 * k, *b_i15_cur = b + 15 * k;
     
        for (int i = 0; i < k; i += 2)
        {
            float64x2_t a_reg = vld1q_f64(a_cur);       // ä¸€æ¬¡æ¨ªç€åŠ è½½ä¸¤ä¸ªæ•°
            float64x2_t b_i0_reg = vld1q_f64(b_i0_cur), // ä¸€æ¬¡ç«–ç€åŠ è½½ä¸¤ä¸ªæ•°
                b_i1_reg = vld1q_f64(b_i1_cur),
                        b_i2_reg = vld1q_f64(b_i2_cur),
                        b_i3_reg = vld1q_f64(b_i3_cur),
                        b_i4_reg = vld1q_f64(b_i4_cur),
                        b_i5_reg = vld1q_f64(b_i5_cur),
                        b_i6_reg = vld1q_f64(b_i6_cur),
                        b_i7_reg = vld1q_f64(b_i7_cur),
                        b_i8_reg = vld1q_f64(b_i8_cur),
                        b_i9_reg = vld1q_f64(b_i9_cur),
                        b_i10_reg = vld1q_f64(b_i10_cur),
                        b_i11_reg = vld1q_f64(b_i11_cur),
                        b_i12_reg = vld1q_f64(b_i12_cur),
                        b_i13_reg = vld1q_f64(b_i13_cur),
                        b_i14_reg = vld1q_f64(b_i14_cur),
                        b_i15_reg = vld1q_f64(b_i15_cur);
     
            resi0 += (a_reg[0] * b_i0_reg[0] + a_reg[1] * b_i0_reg[1]);
            resi1 += (a_reg[0] * b_i1_reg[0] + a_reg[1] * b_i1_reg[1]);
            resi2 += (a_reg[0] * b_i2_reg[0] + a_reg[1] * b_i2_reg[1]);
            resi3 += (a_reg[0] * b_i3_reg[0] + a_reg[1] * b_i3_reg[1]);
            resi4 += (a_reg[0] * b_i4_reg[0] + a_reg[1] * b_i4_reg[1]);
            resi5 += (a_reg[0] * b_i5_reg[0] + a_reg[1] * b_i5_reg[1]);
            resi6 += (a_reg[0] * b_i6_reg[0] + a_reg[1] * b_i6_reg[1]);
            resi7 += (a_reg[0] * b_i7_reg[0] + a_reg[1] * b_i7_reg[1]);
            resi8 += (a_reg[0] * b_i8_reg[0] + a_reg[1] * b_i8_reg[1]);
            resi9 += (a_reg[0] * b_i9_reg[0] + a_reg[1] * b_i9_reg[1]);
            resi10 += (a_reg[0] * b_i10_reg[0] + a_reg[1] * b_i10_reg[1]);
            resi11 += (a_reg[0] * b_i11_reg[0] + a_reg[1] * b_i11_reg[1]);
            resi12 += (a_reg[0] * b_i12_reg[0] + a_reg[1] * b_i12_reg[1]);
            resi13 += (a_reg[0] * b_i13_reg[0] + a_reg[1] * b_i13_reg[1]);
            resi14 += (a_reg[0] * b_i14_reg[0] + a_reg[1] * b_i14_reg[1]);
            resi15 += (a_reg[0] * b_i15_reg[0] + a_reg[1] * b_i15_reg[1]);
     
            a_cur += 2;
            b_i0_cur += 2;
            b_i1_cur += 2;
            b_i2_cur += 2;
            b_i3_cur += 2;
            b_i4_cur += 2;
            b_i5_cur += 2;
            b_i6_cur += 2;
            b_i7_cur += 2;
            b_i8_cur += 2;
            b_i9_cur += 2;
            b_i10_cur += 2;
            b_i11_cur += 2;
            b_i12_cur += 2;
            b_i13_cur += 2;
            b_i14_cur += 2;
            b_i15_cur += 2;
        }
     
        *(c) = resi0;
        *(c + 1) = resi1;
        *(c + 2) = resi2;
        *(c + 3) = resi3;
        *(c + 4) = resi4;
        *(c + 5) = resi5;
        *(c + 6) = resi6;
        *(c + 7) = resi7;
        *(c + 8) = resi8;
        *(c + 9) = resi9;
        *(c + 10) = resi10;
        *(c + 11) = resi11;
        *(c + 12) = resi12;
        *(c + 13) = resi13;
        *(c + 14) = resi14;
        *(c + 15) = resi15;
    }
    
    void Seg1x16Multiply(double *a, double *b, double *c, int m, int k, int n)
    {
        cout<<"Seg1x16Multiply: \n";
        Transpose(a, m, k);
        double *a_cur = a, *b_cur, *c_cur = c;
        long long int i, j;
        for (i = 0; i < m; i += 1, a_cur += 1 * k, c_cur += 1 * n)
        {
            b_cur = b;
            for (j = 0; j < n; j += 16, b_cur += 16 * k)
            {
                // Seg2x4(k, a + i * k, b + j * k, c + i * n + j);
                Seg1x16(k, a_cur, b_cur, c_cur + j);
            }
        }
    }
    
    ```
    
- *Seg2x4Multiply*
    
    ```cpp
    #include <arm_neon.h>
    
    extern void Transpose(double *arr, int m, int n);
    void Transpose(double *arr, int m, int n)
    {
        double *arr_cur = arr, tmp;
        for (long long int i = 0; i < m; i++)
        {
            for (long long int j = i + 1; j < n; j++)
            {
                tmp = arr[i * n + j];
                arr[i * n + j] = arr[i + n * j];
                arr[i + n * j] = tmp;
            }
        }
    }
    
    void Matrix2x4_allIntrinsic(int k, double *a, const double *b, double *c)
    {
        double *a_0j_cur = a, *a_1j_cur = a + k;
        const double *b_i0_cur = b, *b_i1_cur = b + 1 * k, *b_i2_cur = b + 2 * k, *b_i3_cur = b + 3 * k;
    
        float64x2_t res0_01_reg = {0}, res0_23_reg = {0},
                    res1_01_reg = {0}, res1_23_reg = {0};
    
        for (int i = 0; i < k; i++)
        {
            float64_t a_0j_reg = *a_0j_cur,
                      a_1j_reg = *a_1j_cur;
            float64x2_t b_i01_reg,
                b_i23_reg;
    
            b_i01_reg = vld1q_lane_f64(b_i0_cur, b_i01_reg, 0);
            b_i01_reg = vld1q_lane_f64(b_i1_cur, b_i01_reg, 1);
            b_i23_reg = vld1q_lane_f64(b_i2_cur, b_i23_reg, 0);
            b_i23_reg = vld1q_lane_f64(b_i3_cur, b_i23_reg, 1);
    
            res0_01_reg = vfmaq_n_f64(res0_01_reg, b_i01_reg, a_0j_reg);
            res0_23_reg = vfmaq_n_f64(res0_23_reg, b_i23_reg, a_0j_reg);
            res1_01_reg = vfmaq_n_f64(res1_01_reg, b_i01_reg, a_1j_reg);
            res1_23_reg = vfmaq_n_f64(res1_23_reg, b_i23_reg, a_1j_reg);
    
            a_0j_cur++;
            a_1j_cur++;
            b_i0_cur++;
            b_i1_cur++;
            b_i2_cur++;
            b_i3_cur++;
        }
        vst1q_f64(c, res0_01_reg);
        vst1q_f64(c + 2, res0_23_reg);
        vst1q_f64(c + k, res1_01_reg);
        vst1q_f64(c + k + 2, res1_23_reg);
    }
    void Seg2x4Multiply(double *a, double *b, double *c, int m, int k, int n)
    {
        Transpose(a, m, k);
        double *a_cur = a, *b_cur, *c_cur = c;
        long long int i, j;
        for (i = 0; i < m; i += 2, a_cur += 2 * k, c_cur += 2 * n)
        {
            b_cur = b;
            for (j = 0; j < n; j += 4, b_cur += 4 * k)
            {
                // Matrix2x4_allIntrinsic(k, a + i * k, b + j * k, c + i * n + j);
                Matrix2x4_allIntrinsic(k, a_cur, b_cur, c_cur + j);
            }
        }
    }
    ```
    
- * ***Seg8x6Multiply ï¼ˆopt1ã€opt3)***
    
    ```cpp
    #include <arm_neon.h>
    
    extern void Transpose(double *arr, int m, int n);
    void Matrix8x6_allIntrinsic(int k, double *a, const double *b, double *c)
    {
        double *a_cur = a;
        const double *b_cur = b;
    
        float64x2_t a_01_reg, a_23_reg, a_45_reg, a_67_reg;
        float64x2_t b_01_reg, b_23_reg, b_45_reg;
        float64x2_t res0_01_reg = {0}, res0_23_reg = {0}, res0_45_reg = {0},
                    res1_01_reg = {0}, res1_23_reg = {0}, res1_45_reg = {0},
                    res2_01_reg = {0}, res2_23_reg = {0}, res2_45_reg = {0},
                    res3_01_reg = {0}, res3_23_reg = {0}, res3_45_reg = {0},
                    res4_01_reg = {0}, res4_23_reg = {0}, res4_45_reg = {0},
                    res5_01_reg = {0}, res5_23_reg = {0}, res5_45_reg = {0},
                    res6_01_reg = {0}, res6_23_reg = {0}, res6_45_reg = {0},
                    res7_01_reg = {0}, res7_23_reg = {0}, res7_45_reg = {0};
    
        for (int i = 0; i < k; i++)
        {
            a_01_reg = vld1q_f64(a_cur);
            a_23_reg = vld1q_f64(a_cur + 2);
            a_45_reg = vld1q_f64(a_cur + 4);
            a_67_reg = vld1q_f64(a_cur + 6);
            b_01_reg = vld1q_f64(b_cur);
            b_23_reg = vld1q_f64(b_cur + 2);
            b_45_reg = vld1q_f64(b_cur + 4);
    
            res0_01_reg = vfmaq_n_f64(res0_01_reg, b_01_reg, a_01_reg[0]);
            res0_23_reg = vfmaq_n_f64(res0_23_reg, b_23_reg, a_01_reg[0]);
            res0_45_reg = vfmaq_n_f64(res0_45_reg, b_45_reg, a_01_reg[0]);
            res1_01_reg = vfmaq_n_f64(res1_01_reg, b_01_reg, a_01_reg[1]);
            res1_23_reg = vfmaq_n_f64(res1_23_reg, b_23_reg, a_01_reg[1]);
            res1_45_reg = vfmaq_n_f64(res1_45_reg, b_45_reg, a_01_reg[1]);
            res2_01_reg = vfmaq_n_f64(res2_01_reg, b_01_reg, a_23_reg[0]);
            res2_23_reg = vfmaq_n_f64(res2_23_reg, b_23_reg, a_23_reg[0]);
            res2_45_reg = vfmaq_n_f64(res2_45_reg, b_45_reg, a_23_reg[0]);
            res3_01_reg = vfmaq_n_f64(res3_01_reg, b_01_reg, a_23_reg[1]);
            res3_23_reg = vfmaq_n_f64(res3_23_reg, b_23_reg, a_23_reg[1]);
            res3_45_reg = vfmaq_n_f64(res3_45_reg, b_45_reg, a_23_reg[1]);
            res4_01_reg = vfmaq_n_f64(res4_01_reg, b_01_reg, a_45_reg[0]);
            res4_23_reg = vfmaq_n_f64(res4_23_reg, b_23_reg, a_45_reg[0]);
            res4_45_reg = vfmaq_n_f64(res4_45_reg, b_45_reg, a_45_reg[0]);
            res5_01_reg = vfmaq_n_f64(res5_01_reg, b_01_reg, a_45_reg[1]);
            res5_23_reg = vfmaq_n_f64(res5_23_reg, b_23_reg, a_45_reg[1]);
            res5_45_reg = vfmaq_n_f64(res5_45_reg, b_45_reg, a_45_reg[1]);
            res6_01_reg = vfmaq_n_f64(res6_01_reg, b_01_reg, a_67_reg[0]);
            res6_23_reg = vfmaq_n_f64(res6_23_reg, b_23_reg, a_67_reg[0]);
            res6_45_reg = vfmaq_n_f64(res6_45_reg, b_45_reg, a_67_reg[0]);
            res7_01_reg = vfmaq_n_f64(res7_01_reg, b_01_reg, a_67_reg[1]);
            res7_23_reg = vfmaq_n_f64(res7_23_reg, b_23_reg, a_67_reg[1]);
            res7_45_reg = vfmaq_n_f64(res7_45_reg, b_45_reg, a_67_reg[1]);
    
            a_cur += k;
            b_cur += k;
        }
    
        double *c_cur = c;
        vst1q_f64(c_cur, res0_01_reg);
        vst1q_f64(c_cur + 2, res0_23_reg);
        vst1q_f64(c_cur + 4, res0_45_reg);
        c_cur += k;
        vst1q_f64(c_cur, res1_01_reg);
        vst1q_f64(c_cur + 2, res1_23_reg);
        vst1q_f64(c_cur + 4, res1_45_reg);
        c_cur += k;
        vst1q_f64(c_cur, res2_01_reg);
        vst1q_f64(c_cur + 2, res2_23_reg);
        vst1q_f64(c_cur + 4, res2_45_reg);
        c_cur += k;
        vst1q_f64(c_cur, res3_01_reg);
        vst1q_f64(c_cur + 2, res3_23_reg);
        vst1q_f64(c_cur + 4, res3_45_reg);
        c_cur += k;
        vst1q_f64(c_cur, res4_01_reg);
        vst1q_f64(c_cur + 2, res4_23_reg);
        vst1q_f64(c_cur + 4, res4_45_reg);
        c_cur += k;
        vst1q_f64(c_cur, res5_01_reg);
        vst1q_f64(c_cur + 2, res5_23_reg);
        vst1q_f64(c_cur + 4, res5_45_reg);
        c_cur += k;
        vst1q_f64(c_cur, res6_01_reg);
        vst1q_f64(c_cur + 2, res6_23_reg);
        vst1q_f64(c_cur + 4, res6_45_reg);
        c_cur += k;
        vst1q_f64(c_cur, res7_01_reg);
        vst1q_f64(c_cur + 2, res7_23_reg);
        vst1q_f64(c_cur + 4, res7_45_reg);
    }
    
    void Seg8x6Multiply(double *a, double *b, double *c, int m, int k, int n)
    {
        Transpose(b, k, n);
        int i, j;
        for (i = 0; i < m; i += 8)
        {
            for (j = 0; j < n; j += 6)
            {
                Matrix8x6_allIntrinsic(k, a + i, b + j, c + i * n + j);
            }
        }
    }
    ```
    
- * ***Interval_Seg8x6Multiply(opt1ã€opt2ã€opt3)***
    
    ```cpp
    /*
        
        from -> k * m, 4 * 8// åˆ—ä¸»åº
        1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5
        1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5
    
        to
        seg 8row x 4 col
        col1: 1 2 3 4 5 6 7 8 // éƒ½è¦å’ŒBçš„ç¬¬ä¸€è¡Œå…ƒç´ ç›¸ä¹˜
        col2: 0 1 2 3 4 5 6 7
        col3: 1 2 3 4 5 6 7 8
        col4: 0 1 2 3 4 5 6 7
    
        9 0 1 2 3 4 5 6
        8 9 0 1 2 3 4 5
        9 0 1 2 3 4 5 6
        8 9 0 1 2 3 4 5
    */
    void PACKA_8(double *from, double *to, int m, int k){
        double *f_offset = from, * t_offset = to;
    
        for(int i = 0 ; i < m ; i += 8){
            f_offset = from + i;
            for(int j = 0 ; j < k ; j++){
                memcpy(t_offset, f_offset, 64); // æ‹·è´8ä¸ªdoubleï¼Œ 64ä¸ªå­—èŠ‚åˆ°toçš„å†…å­˜ç©ºé—´
                f_offset += m;
                t_offset += 8;
            }
        }
    }
    
    /*
        from -> n * k, 12 * 4
        1 2 3 4
        1 2 3 4
        1 2 3 4
        1 2 3 4
        1 2 3 4
        1 2 3 4
        1 2 3 4
        1 2 3 4
        1 2 3 4
        1 2 3 4
        1 2 3 4
        1 2 3 4
    
        to
        seg 4row x 6col
        row1: 1 1 1 1 1 1
        row2: 2 2 2 2 2 2
        row3: 3 3 3 3 3 3
        row4: 4 4 4 4 4 4
    
        1 1 1 1 1 1
        2 2 2 2 2 2
        3 3 3 3 3 3
        4 4 4 4 4 4
    
    */
    void PACKB_6(double *from, double *to, int n, int k){
        double *f_offset1,
                *f_offset2,
                *f_offset3,
                *f_offset4,
                *f_offset5,
                *f_offset6;
    
        double *t_offset1 = to, *t_offset2 = t_offset1 + 1, *t_offset3 = t_offset2 + 1, *t_offset4 = t_offset3 + 1, *t_offset5 = t_offset4 + 1, *t_offset6 = t_offset5 + 1;
    
        for(int i = 0 ; i < n ; i += 6){
            f_offset1 = from + i * k;
            f_offset2 = f_offset1 + k,
            f_offset3 = f_offset2 + k,
            f_offset4 = f_offset3 + k,
            f_offset5 = f_offset4 + k,
            f_offset6 = f_offset5 + k;
            for(int j = 0 ; j < k ; j++){
                (*t_offset1) = (*f_offset1); (*t_offset2) = (*f_offset2); (*t_offset3) = (*f_offset3); (*t_offset4) = (*f_offset4);  (*t_offset5) = (*f_offset5); (*t_offset6) = (*f_offset6);
                t_offset1 += 6; t_offset2 = t_offset1 + 1; t_offset3 = t_offset2 + 1; t_offset4 = t_offset3 + 1; t_offset5 = t_offset4 + 1; t_offset6 = t_offset5 + 1;
                ++ f_offset1;
                ++ f_offset2;
                ++ f_offset3;
                ++ f_offset4;
                ++ f_offset5;
                ++ f_offset6;
            }
            
        }
    }
    
    void Interval_Seg8x6(int k, double *a, const double *b, double *c){
        double *a_offset = a;
        const double *b_offset = b;
    
        float64x2_t res0_01, res0_23, res0_45,
                    res1_01, res1_23, res1_45,
                    res2_01, res2_23, res2_45,
                    res3_01, res3_23, res3_45,
                    res4_01, res4_23, res4_45,
                    res5_01, res5_23, res5_45,
                    res6_01, res6_23, res6_45,
                    res7_01, res7_23, res7_45;
                    
    
        float64x2_t a_01, a_23, a_45, a_67;
        float64x2_t b_01, b_23, b_45;
    
        for(int i = 0 ; i < k ; i ++){
            // data load
            a_01 = vld1q_f64(a_offset); a_23 = vld1q_f64(a_offset + 2); a_45 = vld1q_f64(a_offset + 4); a_67 = vld1q_f64(a_offset + 6);
            a_offset += 8;
            
            b_01 = vld1q_f64(b_offset); b_23 = vld1q_f64(b_offset + 2); b_45 = vld1q_f64(b_offset + 4); 
            b_offset += 6;
            
            res0_01 = vfmaq_n_f64(res0_01, b_01, a_01[0]); res0_23 = vfmaq_n_f64(res0_23, b_23, a_01[0]); res0_45 = vfmaq_n_f64(res0_45, b_45, a_01[0]);
            res1_01 = vfmaq_n_f64(res1_01, b_01, a_01[1]); res1_23 = vfmaq_n_f64(res1_23, b_23, a_01[1]); res1_45 = vfmaq_n_f64(res1_45, b_45, a_01[1]);
            res2_01 = vfmaq_n_f64(res2_01, b_01, a_23[0]); res2_23 = vfmaq_n_f64(res2_23, b_23, a_23[0]); res2_45 = vfmaq_n_f64(res2_45, b_45, a_23[0]);
            res3_01 = vfmaq_n_f64(res3_01, b_01, a_23[1]); res3_23 = vfmaq_n_f64(res3_23, b_23, a_23[1]); res3_45 = vfmaq_n_f64(res3_45, b_45, a_23[1]);
            res4_01 = vfmaq_n_f64(res4_01, b_01, a_45[0]); res4_23 = vfmaq_n_f64(res4_23, b_23, a_45[0]); res4_45 = vfmaq_n_f64(res4_45, b_45, a_45[0]);
            res5_01 = vfmaq_n_f64(res5_01, b_01, a_45[1]); res5_23 = vfmaq_n_f64(res5_23, b_23, a_45[1]); res5_45 = vfmaq_n_f64(res5_45, b_45, a_45[1]);
            res6_01 = vfmaq_n_f64(res6_01, b_01, a_67[0]); res6_23 = vfmaq_n_f64(res6_23, b_23, a_67[0]); res6_45 = vfmaq_n_f64(res6_45, b_45, a_67[0]);
            res7_01 = vfmaq_n_f64(res7_01, b_01, a_67[1]); res7_23 = vfmaq_n_f64(res7_23, b_23, a_67[1]); res7_45 = vfmaq_n_f64(res7_45, b_45, a_67[1]);
        }
    
        double *c_cur = c;
        vst1q_f64(c_cur, res0_01);
        vst1q_f64(c_cur + 2, res0_23);
        vst1q_f64(c_cur + 4, res0_45);
        c_cur += k;
        vst1q_f64(c_cur, res1_01);
        vst1q_f64(c_cur + 2, res1_23);
        vst1q_f64(c_cur + 4, res1_45);
        c_cur += k;
        vst1q_f64(c_cur, res2_01);
        vst1q_f64(c_cur + 2, res2_23);
        vst1q_f64(c_cur + 4, res2_45);
        c_cur += k;
        vst1q_f64(c_cur, res3_01);
        vst1q_f64(c_cur + 2, res3_23);
        vst1q_f64(c_cur + 4, res3_45);
        c_cur += k;
        vst1q_f64(c_cur, res4_01);
        vst1q_f64(c_cur + 2, res4_23);
        vst1q_f64(c_cur + 4, res4_45);
        c_cur += k;
        vst1q_f64(c_cur, res5_01);
        vst1q_f64(c_cur + 2, res5_23);
        vst1q_f64(c_cur + 4, res5_45);
        c_cur += k;
        vst1q_f64(c_cur, res6_01);
        vst1q_f64(c_cur + 2, res6_23);
        vst1q_f64(c_cur + 4, res6_45);
        c_cur += k;
        vst1q_f64(c_cur, res7_01);
        vst1q_f64(c_cur + 2, res7_23);
        vst1q_f64(c_cur + 4, res7_45);
    }
    
    void Interval_Seg8x6Multiply(double *a, double *b, double *c, int m, int k, int n)
    {
        cout<<"Interval_Seg8x6Multiply: \n";
    
        double a_[m * k], b_[k * n];
        PACKA_8(a, a_, m, k);
        // PrintMatrix(a, k, m);
        // PrintMatrix(a_, k * m / 8, 8);
    
        PACKB_6(b, b_, k, n);
        // PrintMatrix(b, n, k);
        // PrintMatrix(b_, n * k / 6, 6);
    
        int i, j;
        for (i = 0; i < m; i += 8)
        {
            for (j = 0; j < n; j += 6)
            {
                Interval_Seg8x6(k, a_ + i * k, b_ + j * k, c + i * n + j);
            }
        }
    }
    ```
    
- test
    
    ```cpp
    #include <iostream>
    #include <algorithm>
    #include <cstdlib>
    #include <ctime>
    #include <chrono>
    #include <math.h>
    #include <arm_neon.h>
    using namespace std;
    
    #include "PureMultiply.h"
    #include "Seg8x6Multiply.h"
    #include "Seg2x4Multiply.h"
    
    #define M 240
    #define K 240
    #define N 240
    
    #define THRESHOLD 1e-6
    
    void Initialize(double *arr, int m, int n)
    {
        srand(time(0));
        for (long long int i = 0; i < m; i++)
        {
            for (long long int j = 0; j < n; j++)
                arr[i * n + j] = (double)rand() / RAND_MAX * 10;
        }
    }
    
    static double get_time(struct timespec *start,
                           struct timespec *end)
    {
        return end->tv_sec - start->tv_sec + (end->tv_nsec - start->tv_nsec) * 1e-9;
    }
    
    bool check(double c_ref[], double c[])
    {
        for (int i = 0; i < M; i++)
        {
            for (int j = 0; j < N; j++)
            {
                double diff = fabs(c_ref[i * N + j] - c[i * N + j]);
                if (diff > THRESHOLD)
                {
                    cout << "[" << i << ", " << j << "] c_ref: " << c_ref[i * N + j]
                         << ", c: " << c[i * N + j] << "\n--------------------------------------\n";
                    return false;
                }
            }
        }
        return true;
    }
    
    void PrintMatrix(double c[])
    {
        for (int i = 0; i < M; i++)
        {
            for (int j = 0; j < N; j++)
            {
                cout << c[i * N + j] << " ";
            }
            cout << endl;
        }
        cout << "-------------------\n";
    }
    
    int main()
    {
    
        double A[M * K], B[K * N];
    
        Initialize(A, M, K);
        Initialize(B, K, N);
    
        double gflops = 2.0 * M * N * K * 1.0e-09, time_tmp;
        struct timespec start, end;
    
        double C_ref[M * N], C[M * N];
        PureMultiply(A, B, C_ref, M, K, N);
    
        clock_gettime(CLOCK_MONOTONIC_RAW, &start);
        PureMultiply(A, B, C, M, K, N);
        // Seg2x4Multiply(A, B, C, M, K, N);
        // Seg8x6Multiply(A, B, C, M, K, N);
    		Interval_Seg8x6Multiply(A, B, C, M, K, N);
        clock_gettime(CLOCK_MONOTONIC_RAW, &end);
        time_tmp = get_time(&start, &end);
    
        cout << "time_cost: " << time_tmp << ", gflops : " << gflops / time_tmp << endl;
        std::cout << "--------------------------------------" << std::endl;
    
        check(C_ref, C);
    
        // PrintMatrix(C_ref);
        // PrintMatrix(C);
    
        return 0;
    }
    ```
    

# ğŸ‘¾Â å…¶ä»–ç¡¬ä»¶æµ‹è¯•

- m1 pro ä¸Šçš„æµ‹è¯•
    - m1 pro
        
        ![](https://20231118-1258904223.cos.ap-shanghai.myqcloud.com/image/202602011758172.png)
        
        **æµ‹è¯•ç»“æœ**
        
        å¯ä»¥çœ‹åˆ°fmlaçš„ç»“æœæ˜¯100.98GFlopsï¼Œæµ‹è¯•çš„æ˜¯float32ï¼Œè€Œæœ¬æµ‹è¯•demoä¸­æ˜¯float64ï¼Œå› æ­¤ï¼Œç†è®ºä¸Šåº”è¯¥å‡åŠï¼Œä¹Ÿå°±æ˜¯50.49GFlops
        
        - å¼€å¯O3ç¼–è¯‘ï¼š`g++ -O3 -ftree-vectorize test.cpp -o test`
        
        |  | GFlops_Percent |  GFlops |
        | --- | --- | --- |
        | *PureMultiply* | 3.09% | 1.56 |
        | *Seg2x4Multiply* | 17.3% | 8.74 |
        | *Seg8x6Multiply* | 54.5% | 27.5 |
        | *Interval_Seg8x6Multiply* | 56.2% | 28.37 |
        | ASMSeg8x6Multiply | 63.45% | 32.04 |