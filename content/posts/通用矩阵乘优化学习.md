
---
title: "é€šç”¨çŸ©é˜µä¹˜ä¼˜åŒ–å­¦ä¹ "
date: "2023-03-15"
author: "NeysaBan"
category: "cpu"
tags:
- cpu
- simd
- x86
- arm
readTime: "12åˆ†é’Ÿ"
---

ğŸ‘¾ **èƒŒæ™¯**
åœ¨å­¦ä¹ äº†how-to-optimize-gemmä¹‹åï¼Œå¾ˆå¿«åœ¨å®ä¹ ä¸­ç”¨åˆ°äº†çŸ©é˜µä¼˜åŒ–çš„ç›¸å…³çŸ¥è¯†ï¼›ä»¥ä¸‹æ˜¯å…·ä½“çš„èƒŒæ™¯
- éœ€è¦ä¼˜åŒ–çš„æ¨¡å—å®é™…ä¸Šæœ‰30ä¸ªè¿ç»­çš„å¾ªç¯ï¼ŒçŸ©é˜µå…ƒç´ éƒ½æ˜¯doubleç±»å‹ï¼›
- 30ä¸ªå¾ªç¯ä¸­ï¼Œåˆ†æçƒ­ç‚¹ä¹‹åï¼Œé€‰æ‹©ç¬¬10ä¸ªå¾ªç¯ä½œä¸ºä¾‹å­ï¼Œç¬¬10ä¸ªå¾ªç¯å®é™…ä¸Šæ˜¯ä¸‰ä¸ªçŸ©é˜µç›¸ä¹˜
    - æŠŠå…¶ä¸­çš„çŸ©é˜µåéƒ½æ¢æˆæ²¡æœ‰å®é™…æ„ä¹‰çš„$aã€bã€c$ï¼Œ$mid\_res$æŒ‡å‰ä¸¤ä¸ªçŸ©é˜µ$aã€b$ç›¸ä¹˜çš„ä¸­é—´ç»“æœï¼Œ$res$æŒ‡$mid\_res$å’Œ$c$ç›¸ä¹˜çš„æœ€ç»ˆç»“æœï¼›
    - æŒ‰ç…§å®é™…åœºæ™¯ï¼ŒçŸ©é˜µ$a$æ˜¯$60 \times 120$çš„çŸ©é˜µï¼ŒçŸ©é˜µ$b$æ˜¯$120 \times 60$çš„çŸ©é˜µï¼ŒçŸ©é˜µ$c$æ˜¯$60 \times 60$çš„çŸ©é˜µã€‚åœ¨æœªä¼˜åŒ–ä¹‹å‰ï¼Œè¡Œä¹˜çŸ©é˜µï¼ˆ $a, mid\_res$ ï¼‰éƒ½æ˜¯æŒ‰åˆ—å­˜å‚¨çš„ã€‚
- æ¨¡å‹ä¸»è¦è¿è¡Œçš„å¹³å°æ¶æ„æ˜¯ARM64ï¼Œæ‰€ä»¥åœ¨ARM64æ–¹é¢çš„ä¼˜åŒ–æ›´å¤šä¸€ç‚¹ã€‚
- ç›¸å…³ä»£ç å·²ä¼ åˆ°github
    [https://github.com/NeysaBan/optimze-matrix-instance](https://github.com/NeysaBan/optimze-matrix-instance)

# Overall Resualt

ç»Ÿè®¡æ¯ä¸ªå¾ªç¯èŠ±çš„æ—¶é—´ï¼Œå®šä½ä¼˜åŒ–ä½ç½®

## Time Cost

- ARM64 time cost
    
    ```bash
    HACK1 time_cost: 0.00052 ms,
    HACK2 time_cost: 0.02628 ms,
    HACK3 time_cost: 0.001 ms,
    -----------------HACK4 time_cost: 1.02208 ms,
    HACK5 time_cost: 0.0004 ms,
    HACK6 time_cost: 0.10292 ms,
    HACK7 time_cost: 0.03552 ms,
    -----------------HACK8 time_cost: 1.96308 ms,
    HACK9 time_cost: 0.03328 ms,
    -----------------HACK10 time_cost: 10.637 ms,
    HACK11 time_cost: 0.076399 ms,
    HACK12 time_cost: 0.04676 ms,
    HACK13 time_cost: 0.02876 ms,
    HACK14 time_cost: 0.1064 ms,
    HACK15 time_cost: 0.05968 ms,
    HACK16 time_cost: 0.00024 ms,
    HACK17 time_cost: 0.00028 ms,
    HACK18 time_cost: 0.00028 ms,
    fir_mpc_Interp1D1 time_cost: 0.00028 ms,
    fir_mpc_Interp1D2 time_cost: 0.01952 ms,
    HACK19 time_cost: 0.00216 ms,
    HACK20 time_cost: 0.02628 ms,
    HACK21 time_cost: 0.00048 ms,
    HACK22 time_cost: 0.00016 ms,
    HACK23 time_cost: 0.05828 ms,
    -----------------HACK24 time_cost: 0.995078 ms,
    -----------------HACK25 time_cost: 0.988758 ms,
    HACK26 time_cost: 0.0048 ms,
    HACK27 time_cost: 0.00132 ms,
    HACK28 time_cost: 0.066319 ms,
    HACK29 time_cost: 0.00076 ms,
    HACK30 time_cost: 0.03324 ms,
    calc_constraint time_cost: 16.5604 ms,
    ```
    
- X86 time cost
    
    ```json
    HACK1 time_cost: 0.00016 ms,
    HACK2 time_cost: 0.004331 ms,
    HACK3 time_cost: 0.000251 ms,
    -----------------HACK4 time_cost: 0.338351 ms,
    HACK5 time_cost: 8.8e-05 ms,
    HACK6 time_cost: 0.050415 ms,
    HACK7 time_cost: 0.022426 ms,
    -----------------HACK8 time_cost: 0.707675 ms,
    HACK9 time_cost: 0.006821 ms,
    -----------------HACK10 time_cost: 3.03788 ms,
    HACK11 time_cost: 0.030855 ms,
    HACK12 time_cost: 0.010271 ms,
    HACK13 time_cost: 0.011948 ms,
    HACK14 time_cost: 0.043324 ms,
    HACK15 time_cost: 0.018197 ms,
    HACK16 time_cost: 0.000202 ms,
    HACK17 time_cost: 0.000129 ms,
    HACK18 time_cost: 0.000129 ms,
    fir_mpc_Interp1D1 time_cost: 0.000129 ms,
    fir_mpc_Interp1D2 time_cost: 0.008707 ms,
    HACK19 time_cost: 0.001003 ms,
    HACK20 time_cost: 0.00524 ms,
    HACK21 time_cost: 0.00011 ms,
    HACK22 time_cost: 5.6e-05 ms,
    HACK23 time_cost: 0.014624 ms,
    -----------------HACK24 time_cost: 0.413217 ms,
    -----------------HACK25 time_cost: 0.22408 ms,
    HACK26 time_cost: 0.000964 ms,
    HACK27 time_cost: 0.000313 ms,
    HACK28 time_cost: 0.017027 ms,
    HACK29 time_cost: 0.000196 ms,
    HACK30 time_cost: 0.014172 ms,
    calc_constraint time_cost: 5.11927 ms,
    ```
    

## **Analysis**

æ—¶é—´å æ¯”è¾ƒé«˜çš„å¾ªç¯ï¼šæ—¶é—´å æ¯”æ¯”è¾ƒé«˜çš„æ˜¯ç”¨-----------------æ ‡å‡ºæ¥çš„å¾ªç¯ï¼Œå…¶ä¸­ç¬¬10ä¸ªå¾ªç¯å æ¯”æœ€é«˜ï¼Œä¹Ÿæ˜¯ä¸»è¦çš„ä¼˜åŒ–ç›®æ ‡ï¼›å…¶ä½™å¾ªç¯å æ¯”ç¨é«˜

æ—¶é—´å æ¯”è¾ƒé«˜çš„ä¸‰å¤§åŸå› ï¼š

- æ²¡æœ‰å¿…è¦çš„è®¿å­˜ï¼šè¿™äº›å¾ªç¯çš„é€šç—…æ˜¯æœ€å†…å±‚çš„å¾ªç¯å†…è¿›è¡Œäº†æ²¡æœ‰å¿…è¦çš„è®¿å­˜
- çŸ©é˜µå­˜å‚¨ä¸åˆç†ï¼šè¿™ä¸ªé—®é¢˜ä¸»è¦é›†ä¸­åœ¨HACK10ï¼Œåé¢æœ‰å…·ä½“çš„åˆ†æï¼Œä¸»è¦æ˜¯æŒ‰è¡Œä¹˜çš„çŸ©é˜µæŒ‰åˆ—å­˜ã€æŒ‰åˆ—å­˜çš„çŸ©é˜µæŒ‰è¡Œå­˜ï¼ˆå‰è€…éœ€è¦æ”¹è¿›ï¼Œåè€…åšå¾—æ¯”è¾ƒå¥½ï¼‰
- çŸ©é˜µè¿ç®—æœ‰ä¼˜åŒ–ç©ºé—´ï¼šè¿™ä¸ªé—®é¢˜ä¸»è¦é›†ä¸­åœ¨HACK10ï¼Œåé¢ä¹Ÿä¼šå…·ä½“åˆ†æ

# è®¿å­˜ä¼˜åŒ–

å› ä¸ºæ˜¯é€šç—…ï¼Œæ‰€ä»¥åªæ‹¿å‡ºHACK10æ¥çœ‹

```cpp
// ä¼˜åŒ–å‰
for (i = 0; i < 60; i++) {
    for (k = 0; k < 60; k++) {
      mid_res[i + 60 * k] = 0.0;
      for (i_0 = 0; i_0 < 120; i_0++) {
        Vx_0 = mid_res[60 * k + i];
        Vx_0 +=
            a[60 * i_0 + i] * b[120 * k + i_0];
        mid_res[i + 60 * k] = Vx_0;
      }
    }
    for (k = 0; k < 60; k++) {
      res[i + 60 * k] = 0.0;
      for (i_0 = 0; i_0 < 60; i_0++) {
        Vx_0 = res[60 * k + i];
        Vx_0 +=
            mid_res[60 * i_0 + i] * c[60 * k + i_0];
        res[i + 60 * k] = Vx_0;
      }
    }
  }

// ä¼˜åŒ–åï¼Œå¾ªç¯å˜é‡æ”¹å†™äº†ï¼ˆå› ä¸ºåŸå§‹çš„ä¸å¤ªå¥½ç†è§£ï¼Œè¿™é‡Œå°±æ˜¯mxkçŸ©é˜µä¸kxqçŸ©é˜µç›¸ä¹˜å¾—åˆ°çš„ç»“æœçŸ©é˜µï¼Œå†ä¸ä¸€ä¸ªqxnçš„çŸ©é˜µç›¸ä¹˜ï¼‰
    int m, q, n;
    for (m = 0; m < 60; m++) {
        for (q = 0; q < 60; q++) {
            double tmp_value = 0.0;
            for (k = 0; k < 120; k++) { // ä¸­é—´æ•°
                tmp_value += a[m + 60 * k] * b[k + q*120];
            }
            mid_res[m + 60 * q] = tmp_value;
        }
        for (n = 0; n < 60; n++){
            double tmp_value = 0.0;
            for (q = 0; q < 60; q++) {  // ä¸­é—´æ•°
                tmp_value += mid_res[m + 60 * q] * c[q + n * 60];
            }
            res[m + n * 60] = tmp_value;
        }
    }
```

- HACK10è¿›è¡Œè®¿å­˜ä¼˜åŒ–ååœ¨armå¹³å°çš„è¡¨ç°
    
    ```cpp
    HACK10 time_cost: 4.67539 ms,
    calc_constraint time_cost: 10.4744 ms,
    HACK10 time_cost: 4.66911 ms,
    calc_constraint time_cost: 10.3803 ms,
    HACK10 time_cost: 4.64539 ms,
    calc_constraint time_cost: 10.3589 ms,
    HACK10 time_cost: 4.65203 ms,
    calc_constraint time_cost: 10.3723 ms,
    HACK10 time_cost: 4.65515 ms,
    calc_constraint time_cost: 10.3662 ms,
    HACK10 time_cost: 4.65239 ms,
    calc_constraint time_cost: 10.3834 ms,
    HACK10 time_cost: 4.66207 ms,
    calc_constraint time_cost: 10.3663 ms,
    HACK10 time_cost: 4.66595 ms,
    calc_constraint time_cost: 10.4018 ms,
    HACK10 time_cost: 4.65351 ms,
    calc_constraint time_cost: 10.369 ms,
    HACK10 time_cost: 4.66055 ms,
    calc_constraint time_cost: 10.3865 ms,
    HACK10 time_cost: 4.65475 ms,
    calc_constraint time_cost: 10.3666 ms,
    HACK10 time_cost: 4.65695 ms,
    calc_constraint time_cost: 10.3567 ms,
    HACK10 time_cost: 4.65219 ms,
    calc_constraint time_cost: 10.3621 ms,
    HACK10 time_cost: 4.65391 ms,
    calc_constraint time_cost: 10.3717 ms,
    HACK10 time_cost: 4.65231 ms,
    calc_constraint time_cost: 10.3629 ms,
    HACK10 time_cost: 4.65319 ms,
    calc_constraint time_cost: 10.3743 ms,
    HACK10 time_cost: 4.65935 ms,
    calc_constraint time_cost: 10.3599 ms,
    HACK10 time_cost: 4.65887 ms,
    calc_constraint time_cost: 10.3711 ms,
    HACK10 time_cost: 4.66727 ms,
    calc_constraint time_cost: 10.3782 ms,
    HACK10 time_cost: 4.64243 ms,
    calc_constraint time_cost: 10.3646 ms
    
    åŸºæœ¬ä¸Šæ˜¯å‡å°‘äº†ä¸€åŠå¤šçš„æ—¶é—´
    ```
    
- ä¸Šè¿°çƒ­ç‚¹å¾ªç¯éƒ½è¿›è¡Œè®¿å­˜ä¼˜åŒ–ä¹‹ååœ¨ARMå¹³å°ä¸Šçš„è¡¨ç°
    
    ```cpp
    calc_constraint time_cost: 9.85606 ms,
    
    calc_constraint time_cost: 9.81566 ms,
    
    calc_constraint time_cost: 9.81942 ms,
    
    calc_constraint time_cost: 9.80014 ms,
    
    calc_constraint time_cost: 9.8135 ms,
    
    calc_constraint time_cost: 9.8043 ms,
    
    calc_constraint time_cost: 9.81886 ms,
    
    calc_constraint time_cost: 9.79838 ms,
    
    calc_constraint time_cost: 9.81526 ms,
    
    calc_constraint time_cost: 9.84778 ms,
    
    calc_constraint time_cost: 9.8041 ms,
    
    calc_constraint time_cost: 9.8053 ms,
    
    calc_constraint time_cost: 9.79918 ms,
    
    calc_constraint time_cost: 9.80322 ms,
    
    calc_constraint time_cost: 9.80034 ms,
    
    calc_constraint time_cost: 9.80746 ms,
    
    calc_constraint time_cost: 9.80634 ms,
    
    calc_constraint time_cost: 9.80538 ms,
    
    calc_constraint time_cost: 9.80054 ms,
    
    calc_constraint time_cost: 9.80746 ms,
    ```
    
- ä¸Šè¿°çƒ­ç‚¹å¾ªç¯éƒ½è¿›è¡Œè®¿å­˜ä¼˜åŒ–ä¹‹ååœ¨X86å¹³å°ä¸Šçš„è¡¨ç°
    
    ```cpp
    calc_constraint time_cost: 3.0346 ms,
    calc_constraint time_cost: 3.12727 ms,
    calc_constraint time_cost: 3.23358 ms,
    calc_constraint time_cost: 3.05222 ms,
    calc_constraint time_cost: 3.32154 ms,
    calc_constraint time_cost: 3.04035 ms,
    calc_constraint time_cost: 3.27274 ms,
    calc_constraint time_cost: 3.2993 ms,
    calc_constraint time_cost: 3.22757 ms,
    calc_constraint time_cost: 3.37583 ms,
    calc_constraint time_cost: 3.088 ms,
    calc_constraint time_cost: 3.4818 ms,
    calc_constraint time_cost: 3.32055 ms,
    calc_constraint time_cost: 3.17948 ms,
    calc_constraint time_cost: 3.13336 ms,
    calc_constraint time_cost: 3.31571 ms,
    calc_constraint time_cost: 3.37515 ms,
    calc_constraint time_cost: 3.24978 ms,
    calc_constraint time_cost: 3.29302 ms,
    calc_constraint time_cost: 3.25974 ms,
    ```
    

# HACK10

ç”±äºå…¶ä»–å‡ ä¸ªå¾ªç¯æ˜¯æ¯”è¾ƒç®€å•çš„è®¿å­˜é€šç—…ï¼Œæ‰€ä»¥è¿™é‡Œä¸å†èµ˜è¿°ï¼Œåé¢ä¸»è¦å†™æ˜¯å¦‚ä½•ä¼˜åŒ–çš„HACK10

## **è¿ç®—åˆ†æ**

åé¢è§„å®šéƒ½æŒ‰ç…§$m\times k, k\times q, q \times n$çš„ä¸‰ä¸ªçŸ©é˜µç›¸ä¹˜æ¥è¡¨ç¤º// å› ä¸ºåŸå§‹çš„å½¢å¼ä¸å¥½ç†è§£

å®é™…ä¸Šæ˜¯ä¸€ä¸ªä¸‰ä¸ªçŸ©é˜µç›¸ä¹˜çš„è¿ç®—ï¼›ä»è¿™é‡Œå…¶å®ä¹Ÿå¯ä»¥çœ‹å‡ºçŸ©é˜µåœ¨å†…å­˜ä¸­å¸ƒå±€çš„é—®é¢˜ï¼ŒæŒ‰è¡Œä¹˜çš„çŸ©é˜µ(ä¹Ÿå°±æ˜¯ $a$  å’Œ $mid\_res$ï¼‰æ˜¯æŒ‰åˆ—å­˜çš„

- å‰ä¸¤ä¸ªçŸ©é˜µçš„è®¡ç®—
    
    $mid\_res(m, 60 \times q) += a(m, 60 \times k) \times b(k, 120 \times q)$ 
    
- åé¢çš„è®¡ç®—
  $res(m, 60 \times n) += mid\_res(m, 60 \times q) \times c(60 \times q, n)$

ä»£ç å†™æˆæ¯”è¾ƒå¥½ç†è§£çš„å½¢å¼ï¼Œå¦‚ä¸‹æ‰€ç¤º

```cpp
int m, q, n;
for (m = 0; m < 60; m++) {
    for (q = 0; q < 60; q++) {
        double tmp_value = 0.0;
        for (k = 0; k < 120; k++) {
            tmp_value += a[m + 60 * k] * b[k + q*120];
        }
        mid_res[m + 60 * q] = tmp_value;
    }
    for (n = 0; n < 60; n++){
        double tmp_value = 0.0;
        for (q = 0; q < 60; q++) {
            tmp_value += mid_res[m + 60 * q] * c[q + n * 60];
        }
        res[m + n * 60] = tmp_value;
    }
}
```

**å› æ­¤è®¿å­˜ä¼˜åŒ–å®Œä¹‹åï¼Œä»éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹ä¸»è¦æœ‰ä¸¤ä¸ªï¼š**

- **æ‰“åŒ…å†…å­˜ä¸åˆç†çš„çŸ©é˜µ**
- **çŸ©é˜µä½¿ç”¨intrinsicæŒ‡ä»¤æŒ‰å—è®¡ç®—ï¼ˆå…¶å®ä¹Ÿæ˜¯å‡å°‘äº†è®¿å­˜ï¼‰**

åé¢éƒ½æ˜¯åœ¨æ‰€æœ‰çƒ­ç‚¹å¾ªç¯ä¼˜åŒ–è¿‡è®¿å­˜ä¹‹åçš„ç»“æœï¼Œåˆ†æˆä¸¤ä¸ªå¹³å°æ¥è®°å½•ä¼˜åŒ–è¿‡ç¨‹

## ARM64

### **INTRINSICâ€”â€”ç›´æ¥è®¡ç®—ï¼Œlaneç³»åˆ—æŒ‡ä»¤**

```cpp
for (i = 0; i < 60; i++) {
    // NOTE åœ¨è¿™æ‰“åŒ…a
        for (k = 0; k < 60; k++) {
            int mul_k = k * 60, mul_k1 = mul_k << 1;
            float64x1_t tmp_value = {0};
            float64x2_t a_reg, b_reg;
            for (i_0 = 0; i_0 < 120; i_0 += 2) {
                 
                vld1q_lane_f64(a + 60 * i_0 + i, a_reg, 0);
                vld1q_lane_f64(a + 60 * (i_0 + 1) + i, a_reg, 1);
                vld1q_lane_f64(b + mul_k1 + i_0, b_reg, 0);
                vld1q_lane_f64(b + mul_k1 + i_0 + 1, b_reg, 1);
                vfmaq_lane_f64(b_reg, a_reg, tmp_value, 0); // ä¹˜åŠ 
            }
            vst1_f64(mid_res + i + mul_k, tmp_value);
        }
        // NOTE åœ¨è¿™æ‰“åŒ…mid_res
        for (k = 0; k < 60; k++) {
            int mul_k = k * 60;
            float64x1_t tmp_value = {0};
            float64x2_t c_reg, mid_res_reg;
            for (i_0 = 0; i_0 < 60; i_0 += 2) {
                vld1q_lane_f64(c + mul_k + i_0, c_reg, 0);
                vld1q_lane_f64(c + mul_k + i_0 + 1, c_reg, 1);
                vld1q_lane_f64(mid_res + 60 * i_0 + i, mid_res_reg, 0);
                vld1q_lane_f64(mid_res + 60 * (i_0 + 1) + i, mid_res_reg, 1);
                vfmaq_lane_f64(c_reg, mid_res_reg, tmp_value, 0); // ä¹˜åŠ 
            }
            vst1_f64(res + i + mul_k, tmp_value);
        }
    }
```

- Time Cost
    
    ```cpp
    HACK10 time_cost: 7.8389 ms,
    calc_constraint time_cost: 13.6778 ms,
    HACK10 time_cost: 7.85318 ms,
    calc_constraint time_cost: 13.675 ms,
    HACK10 time_cost: 7.85386 ms,
    calc_constraint time_cost: 13.5867 ms,
    HACK10 time_cost: 7.83854 ms,
    calc_constraint time_cost: 13.5663 ms,
    HACK10 time_cost: 7.83559 ms,
    calc_constraint time_cost: 13.5593 ms,
    HACK10 time_cost: 7.83535 ms,
    calc_constraint time_cost: 13.5643 ms,
    HACK10 time_cost: 7.83386 ms,
    calc_constraint time_cost: 13.5641 ms,
    HACK10 time_cost: 7.8335 ms,
    calc_constraint time_cost: 13.5568 ms,
    HACK10 time_cost: 7.83446 ms,
    calc_constraint time_cost: 13.563 ms,
    HACK10 time_cost: 7.84746 ms,
    calc_constraint time_cost: 13.5727 ms,
    HACK10 time_cost: 7.8489 ms,
    calc_constraint time_cost: 13.5892 ms,
    HACK10 time_cost: 7.85447 ms,
    calc_constraint time_cost: 13.5908 ms,
    HACK10 time_cost: 7.83523 ms,
    calc_constraint time_cost: 13.5634 ms,
    HACK10 time_cost: 7.83534 ms,
    calc_constraint time_cost: 13.5593 ms,
    HACK10 time_cost: 7.83614 ms,
    calc_constraint time_cost: 13.5587 ms,
    HACK10 time_cost: 7.83626 ms,
    calc_constraint time_cost: 13.5648 ms,
    HACK10 time_cost: 7.83762 ms,
    calc_constraint time_cost: 13.5615 ms,
    HACK10 time_cost: 7.83538 ms,
    calc_constraint time_cost: 13.5587 ms,
    HACK10 time_cost: 7.8335 ms,
    calc_constraint time_cost: 13.5611 ms,
    HACK10 time_cost: 7.83619 ms,
    calc_constraint time_cost: 13.5584 ms,
    ```
    

### **INTRINSICâ€”â€”ç›´æ¥è®¡ç®—ï¼Œwithout laneç³»åˆ—æŒ‡ä»¤**

æ„å‘³ç€è¦æ‰“åŒ…æŒ‰åˆ—å­˜å‚¨çš„è¡Œä¹˜çŸ©é˜µ

```cpp
#include <arm_neon.h>

void func(double *old_a, double *old_b, double *old_c, double *old_mid_res, double *res)
{
    int i, k, i_0;
    for (i = 0; i < 60; i++)
    {
        // NOTE åœ¨è¿™æ‰“åŒ…a
        float64_t a[60];
        for (int x = 0; x < 60; x++)
        {
            a[x] = *(old_a + 60 * x + i);
        }
        float64_t b[60];
        for (k = 0; k < 60; k++)
        {
            int mul_k = k * 60;
            for (int x = 0; x < 60; x++)
            {
                b[x] = *(old_b + mul_k + x);
            }

            float64_t tmp_value = {0};
            float64x2_t a_reg, b_reg;
            float64_t *b_cur = b, *a_cur = a;
            for (i_0 = 0; i_0 < 120; i_0 += 2, a_cur += 2, b_cur += 2)
            {
                a_reg = vld1q_f64(a_cur);
                b_reg = vld1q_f64(b_cur);
                vfmaq_n_f64(b_reg, a_reg, tmp_value);
            }
            // vst1_f64(old_mid_res + i + mul_k, tmp_value[0]);
            old_mid_res[i + mul_k] = tmp_value;
        }
        // NOTE åœ¨è¿™æ‰“åŒ…mid_res
        float64_t mid_res[60];
        for (int x = 0; x < 60; x++)
        {
            mid_res[x] = *(old_mid_res + 60 * x + i);
        }
        for (k = 0; k < 60; k++)
        {
            int mul_k = k * 60;
            float64_t c[60];
            for (int x = 0; x < 60; x++)
            {
                c[x] = *(old_c + mul_k + x);
            }
            float64_t tmp_value = {0};
            float64x2_t c_reg, mid_res_reg;
            float64_t *mid_res_cur = mid_res, *c_cur = c;
            for (i_0 = 0; i_0 < 60; i_0 += 2, c_cur += 2, mid_res_cur += 2)
            {
                c_reg = vld1q_f64(c_cur);
                mid_res_reg = vld1q_f64(mid_res_cur);
                vfmaq_n_f64(c_reg, mid_res_reg, tmp_value);
            }
            // vst1_f64(res + i + mul_k, tmp_value);
            res[i + mul_k] = tmp_value;
        }
    }
}
```

- Time Cost
    
    ```cpp
    HACK10 time_cost: 7.29659 ms,
    calc_constraint time_cost: 13.1223 ms,
    HACK10 time_cost: 7.27234 ms,
    calc_constraint time_cost: 13.0193 ms,
    HACK10 time_cost: 7.26706 ms,
    calc_constraint time_cost: 13.0151 ms,
    HACK10 time_cost: 7.27215 ms,
    calc_constraint time_cost: 13.0135 ms,
    HACK10 time_cost: 7.27726 ms,
    calc_constraint time_cost: 13.0142 ms,
    HACK10 time_cost: 7.27398 ms,
    calc_constraint time_cost: 13.0071 ms,
    HACK10 time_cost: 7.26623 ms,
    calc_constraint time_cost: 13.0055 ms,
    HACK10 time_cost: 7.27102 ms,
    calc_constraint time_cost: 13.0027 ms,
    HACK10 time_cost: 7.27123 ms,
    calc_constraint time_cost: 13.0089 ms,
    HACK10 time_cost: 7.27942 ms,
    calc_constraint time_cost: 13.0138 ms,
    HACK10 time_cost: 7.27595 ms,
    calc_constraint time_cost: 13.0217 ms,
    HACK10 time_cost: 7.28323 ms,
    calc_constraint time_cost: 13.0183 ms,
    HACK10 time_cost: 7.27891 ms,
    calc_constraint time_cost: 13.0185 ms,
    HACK10 time_cost: 7.27587 ms,
    calc_constraint time_cost: 13.0213 ms,
    HACK10 time_cost: 7.27363 ms,
    calc_constraint time_cost: 13.0145 ms,
    HACK10 time_cost: 7.27255 ms,
    calc_constraint time_cost: 13.0055 ms,
    HACK10 time_cost: 7.27015 ms,
    calc_constraint time_cost: 13.0074 ms,
    HACK10 time_cost: 7.27155 ms,
    calc_constraint time_cost: 13.0022 ms,
    HACK10 time_cost: 7.27623 ms,
    calc_constraint time_cost: 13.0155 ms,
    HACK10 time_cost: 7.27695 ms,
    calc_constraint time_cost: 13.0124 ms,
    ```
    

### **PACK MATRIX**

```cpp
void PackMatrix(double *des, double *src, int m, int n, int alpha)
{
    double *des_cur = des, *src_cur = src;
    for (int i = 0; i < m; i++)
    {
        for (int j = 0; j < n; j++)
        {
            *(des_cur + j) = *(src_cur + i + alpha * j);
        }
        des_cur += n;
    }
}
int m, q, n, k;
double a[7200];
PackMatrix(a, old_a, 60, 120, 60);
double *a_cur = a;
for (m = 0; m < 60; m++) {
    /* ---------------è®¡ç®—å‰ä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜----------------*/
    double mid_res[60];
    double *mid_res_cur = mid_res;
    for (q = 0; q < 60; q++, mid_res_cur++) {
        double tmp_value = 0.0;
        // ä¸€ä¸ªä¸€ä¸ªç®—
        for (k = 0; k < 120; k++) { // ä¸­é—´æ•°
            tmp_value += *(a_cur + k) * *(b + k + q * 120);
        }
        *(mid_res_cur) = tmp_value;
    }
    /* ---------------è®¡ç®—åä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜----------------*/
    mid_res_cur = mid_res;
    for (n = 0; n < 60; n++){
        double tmp_value = 0.0;
        for (q = 0; q < 60; q++) {  // ä¸­é—´æ•°
            tmp_value += *(mid_res_cur + q) * c[q + n * 60];
        }
        res[m + n * 60] = tmp_value;
    }
    a_cur += 120;
}
```

- Time Cost
    
    ```cpp
    HACK10 time_cost: 4.97995 ms,
    calc_constraint time_cost: 10.175 ms,
    
    HACK10 time_cost: 4.95127 ms,
    calc_constraint time_cost: 10.1066 ms,
    
    HACK10 time_cost: 4.95327 ms,
    calc_constraint time_cost: 10.095 ms,
    
    HACK10 time_cost: 4.93651 ms,
    calc_constraint time_cost: 10.061 ms,
    
    HACK10 time_cost: 4.94691 ms,
    calc_constraint time_cost: 10.0982 ms,
    
    HACK10 time_cost: 4.93499 ms,
    calc_constraint time_cost: 10.0586 ms,
    
    HACK10 time_cost: 4.93219 ms,
    calc_constraint time_cost: 10.0731 ms,
    
    HACK10 time_cost: 4.93391 ms,
    calc_constraint time_cost: 10.0538 ms,
    
    HACK10 time_cost: 4.93271 ms,
    calc_constraint time_cost: 10.0618 ms,
    
    HACK10 time_cost: 4.93207 ms,
    calc_constraint time_cost: 10.0564 ms,
    
    HACK10 time_cost: 4.92711 ms,
    calc_constraint time_cost: 10.0639 ms,
    
    HACK10 time_cost: 4.93783 ms,
    calc_constraint time_cost: 10.0665 ms,
    
    HACK10 time_cost: 4.93023 ms,
    calc_constraint time_cost: 10.0651 ms,
    
    HACK10 time_cost: 4.93715 ms,
    calc_constraint time_cost: 10.0649 ms,
    
    HACK10 time_cost: 4.92883 ms,
    calc_constraint time_cost: 10.0567 ms,
    
    HACK10 time_cost: 4.93447 ms,
    calc_constraint time_cost: 10.0607 ms,
    
    HACK10 time_cost: 4.94971 ms,
    calc_constraint time_cost: 10.089 ms,
    
    HACK10 time_cost: 4.95159 ms,
    calc_constraint time_cost: 10.0847 ms,
    
    HACK10 time_cost: 4.93063 ms,
    calc_constraint time_cost: 10.0787 ms,
    
    HACK10 time_cost: 4.93823 ms,
    calc_constraint time_cost: 10.0671 ms,
    ```
    

### INTRINSICâ€”â€”PACK MATRIX & CAL 1x8

- **ä¸ºä»€ä¹ˆåˆ†æˆ1x8çš„å°å—ï¼Ÿ**
    
    ![](https://20231118-1258904223.cos.ap-shanghai.myqcloud.com/image/202602011750820.png)
    
    - åœ¨å¯¹åº”çš„æœåŠ¡å™¨ä¸Šï¼ŒL1 CACHE Lineçš„å¤§å°æ˜¯64å­—èŠ‚ï¼Œæ­£å¥½å¯ä»¥è£…æ»¡8ä¸ªdouble
    - ç¬¬äºŒä¸ªå¾ªç¯æœ¬èº«ä½¿ç”¨çš„æ˜¯ä¸€è¡Œçš„res_1ï¼Œæ‰€ä»¥æŒ‰1x8

ä¸‹é¢ä¸¤ä¸ªå°æ ‡é¢˜å¯¹åº”çš„åˆ†åˆ«æ˜¯ä½¿ç”¨ä¹˜åŠ æŒ‡ä»¤å’Œä¸ä½¿ç”¨ï¼Œä¸ä½¿ç”¨ä¼šæ›´å¿«ï¼›åŒç»„å¦ä¸€ä¸ªå®ä¹ ç”Ÿå‘Šè¯‰æˆ‘ï¼Œè¿™åº”è¯¥æ˜¯å› ä¸ºä½¿ç”¨intrinsicæŒ‡ä»¤ä¼šæœ‰äº›é¢å¤–çš„åˆ†æ”¯åˆ¤æ–­ï¼Œæ‰€ä»¥ä¸å¦‚ç›´æ¥è®¡ç®—æ¥å¾—å¿«ï¼ˆæ”¹å¤©è‡ªå·±æ‰¾ä¸‹ä»£ç çœ‹ä¸‹

**Intrinsicâ€”â€”without lane, maq, st // åœ¨ARM64å¹³å°ä¸Šæœ€å¿«çš„æ–¹æ¡ˆ**

```cpp
void PackMatrix(double *des, double *src, int m, int n, int alpha){
    double *des_cur = des, *src_cur = src;
    for(int i = 0 ; i < m ; i++){
        for(int j = 0 ; j < n ; j++){
            *(des_cur + j) = *(src_cur + i + alpha * j);
        }
        des_cur += n;
    }
}
 
void Matrix1x8(int k, double *a, const double *b, double *c){
    // æ‰€ä»¥åº”è¯¥æ˜¯açš„ä¸€è¡Œ x bçš„å…«åˆ—
    float64_t resi0 = {0}; // (row, 0)
    float64_t resi1 = {0}; // (row, 1)
    float64_t resi2 = {0}; // (row, 2)
    float64_t resi3 = {0}; // (row, 3)
    float64_t resi4 = {0};
    float64_t resi5 = {0};
    float64_t resi6 = {0};
    float64_t resi7 = {0};
     
    double *a_cur = a;
    const double *b_i0_cur = b, *b_i1_cur = b + 1*k , *b_i2_cur = b + 2*k , *b_i3_cur = b + 3*k,
            *b_i4_cur = b + 4*k, *b_i5_cur = b + 5*k , *b_i6_cur = b + 6*k , *b_i7_cur = b + 7*k;
 
    for(int i = 0 ; i < k ; i += 2){
        float64x2_t a_reg = vld1q_f64(a_cur);   // ä¸€æ¬¡æ¨ªç€åŠ è½½ä¸¤ä¸ªæ•°
        float64x2_t b_i0_reg = vld1q_f64(b_i0_cur),  // ä¸€æ¬¡ç«–ç€åŠ è½½ä¸¤ä¸ªæ•°
                    b_i1_reg = vld1q_f64(b_i1_cur),
                    b_i2_reg = vld1q_f64(b_i2_cur),
                    b_i3_reg = vld1q_f64(b_i3_cur),
                    b_i4_reg = vld1q_f64(b_i4_cur),
                    b_i5_reg = vld1q_f64(b_i5_cur),
                    b_i6_reg = vld1q_f64(b_i6_cur),
                    b_i7_reg = vld1q_f64(b_i7_cur);
 
 
        resi0 += (a_reg[0]*b_i0_reg[0] + a_reg[1]*b_i0_reg[1]);
        resi1 += (a_reg[0]*b_i1_reg[0] + a_reg[1]*b_i1_reg[1]);
        resi2 += (a_reg[0]*b_i2_reg[0] + a_reg[1]*b_i2_reg[1]);
        resi3 += (a_reg[0]*b_i3_reg[0] + a_reg[1]*b_i3_reg[1]);
        resi4 += (a_reg[0]*b_i4_reg[0] + a_reg[1]*b_i4_reg[1]);
        resi5 += (a_reg[0]*b_i5_reg[0] + a_reg[1]*b_i5_reg[1]);
        resi6 += (a_reg[0]*b_i6_reg[0] + a_reg[1]*b_i6_reg[1]);
        resi7 += (a_reg[0]*b_i7_reg[0] + a_reg[1]*b_i7_reg[1]);
 
        a_cur += 2;
        b_i0_cur += 2;
        b_i1_cur += 2;
        b_i2_cur += 2;
        b_i3_cur += 2;
        b_i4_cur += 2;
        b_i5_cur += 2;
        b_i6_cur += 2;
        b_i7_cur += 2;
    }
 
    *(c ) = resi0;
    *(c + 1) = resi1;
    *(c + 2) = resi2;
    *(c + 3) = resi3;
    *(c + 4) = resi4;
    *(c + 5) = resi5;
    *(c + 6) = resi6;
    *(c + 7) = resi7;
}
 
		int m, q, n, k;
    double a[7200];
    PackMatrix(a, old_a, 60, 120, 60);
    double *a_cur = a;
    // double mid_res[3600];
 
    for (m = 0; m < 60; m++) {
        /* ---------------è®¡ç®—å‰ä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜----------------*/
        double mid_res[60];
        double *mid_res_cur = mid_res;
        for (q = 0; q + 8 < 60 ; q += 8, mid_res_cur += 8) {
            double tmp_value = 0.0;
            // ä¸€æ¬¡è®¡ç®—å‡º8ä¸ªæ•°å­—å³m*8ä¸ª
            // ------- è¿™é‡Œç”±äºè¦å†™å›ç»“æœï¼Œæ‰€ä»¥æœ€åä¸€ä¸ªä½ç½®å¾—æ˜¯åŸå§‹çš„æŒ‡é’ˆè€Œéåœ°å€åŠ å’Œçš„ç»“æœ
            Matrix1x8(120, a_cur, b + 120 * q, mid_res_cur);
        }
        for (; q < 60; q++, mid_res_cur++) {
            double tmp_value = 0.0;
            // ä¸€ä¸ªä¸€ä¸ªç®—
            for (k = 0; k < 120; k++) { // ä¸­é—´æ•°
                tmp_value += *(a_cur + k) * *(b + k + q * 120);
            }
            *(mid_res_cur) = tmp_value;
        }
        /* ---------------è®¡ç®—åä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜----------------*/
        mid_res_cur = mid_res;
        for (n = 0; n < 60; n++){
            double tmp_value = 0.0;
            for (q = 0; q < 60; q++) {  // ä¸­é—´æ•°
                tmp_value += *(mid_res_cur + q) * c[q + n * 60];
            }
            res[m + n * 60] = tmp_value;
        }
        a_cur += 120;
  }
```

- Time Cost
    
    ```cpp
    HACK10 time_cost: 3.45783 ms,
    calc_constraint time_cost: 8.70042 ms,
    
    HACK10 time_cost: 3.37631 ms,
    calc_constraint time_cost: 8.52642 ms,
    
    HACK10 time_cost: 3.40039 ms,
    calc_constraint time_cost: 8.54658 ms,
    
    HACK10 time_cost: 3.37307 ms,
    calc_constraint time_cost: 8.52754 ms,
    
    HACK10 time_cost: 3.37571 ms,
    calc_constraint time_cost: 8.50358 ms,
    
    HACK10 time_cost: 3.37091 ms,
    calc_constraint time_cost: 8.51694 ms,
    
    HACK10 time_cost: 3.37455 ms,
    calc_constraint time_cost: 8.57514 ms,
    
    HACK10 time_cost: 3.39343 ms,
    calc_constraint time_cost: 8.58538 ms,
    
    HACK10 time_cost: 3.37723 ms,
    calc_constraint time_cost: 8.55578 ms,
    
    HACK10 time_cost: 3.37403 ms,
    calc_constraint time_cost: 8.5243 ms,
    
    HACK10 time_cost: 3.36647 ms,
    calc_constraint time_cost: 8.50098 ms,
    
    HACK10 time_cost: 3.37455 ms,
    calc_constraint time_cost: 8.5207 ms,
    
    HACK10 time_cost: 3.37179 ms,
    calc_constraint time_cost: 8.50378 ms,
    
    HACK10 time_cost: 3.37815 ms,
    calc_constraint time_cost: 8.5783 ms,
    
    HACK10 time_cost: 3.40363 ms,
    calc_constraint time_cost: 8.60594 ms,
    
    HACK10 time_cost: 3.38695 ms,
    calc_constraint time_cost: 8.56226 ms,
    
    HACK10 time_cost: 3.36815 ms,
    calc_constraint time_cost: 8.5097 ms,
    
    HACK10 time_cost: 3.36359 ms,
    calc_constraint time_cost: 8.49154 ms,
    
    HACK10 time_cost: 3.36763 ms,
    calc_constraint time_cost: 8.51618 ms,
    
    HACK10 time_cost: 3.36467 ms,
    /
    calc_constraint time_cost: 8.49286 ms,
    ```
    

**Intrinsicâ€”â€”without lane, st; with vmlaq_f64 / vfmaq_f64**

```cpp
void PackMatrix(double *des, double *src, int m, int n, int alpha){
    double *des_cur = des, *src_cur = src;
    for(int i = 0 ; i < m ; i++){
        for(int j = 0 ; j < n ; j++){
            *(des_cur + j) = *(src_cur + i + alpha * j);
        }
        des_cur += n;
    }
}
 
void Matrix1x8(int k, double *a, const double *b, double *c){
    // æ‰€ä»¥åº”è¯¥æ˜¯açš„ä¸€è¡Œ x bçš„å…«åˆ—
 
    float64x2_t resi0 = {0}; // (row, 0)
    float64x2_t resi1 = {0}; // (row, 1)
    float64x2_t resi2 = {0}; // (row, 2)
    float64x2_t resi3 = {0}; // (row, 3)
    float64x2_t resi4 = {0};
    float64x2_t resi5 = {0};
    float64x2_t resi6 = {0};
    float64x2_t resi7 = {0};
     
    double *a_cur = a;
    const double *b_i0_cur = b, *b_i1_cur = b + 1*k , *b_i2_cur = b + 2*k , *b_i3_cur = b + 3*k,
            *b_i4_cur = b + 4*k, *b_i5_cur = b + 5*k , *b_i6_cur = b + 6*k , *b_i7_cur = b + 7*k;
 
    for(int i = 0 ; i < k ; i += 2){
        float64x2_t a_reg = vld1q_f64(a_cur);   // ä¸€æ¬¡æ¨ªç€åŠ è½½ä¸¤ä¸ªæ•°
        float64x2_t b_i0_reg = vld1q_f64(b_i0_cur),  // ä¸€æ¬¡ç«–ç€åŠ è½½ä¸¤ä¸ªæ•°
                    b_i1_reg = vld1q_f64(b_i1_cur),
                    b_i2_reg = vld1q_f64(b_i2_cur),
                    b_i3_reg = vld1q_f64(b_i3_cur),
                    b_i4_reg = vld1q_f64(b_i4_cur),
                    b_i5_reg = vld1q_f64(b_i5_cur),
                    b_i6_reg = vld1q_f64(b_i6_cur),
                    b_i7_reg = vld1q_f64(b_i7_cur);
 
        resi0 = vmlaq_f64(resi0, a_reg, b_i0_reg);
        resi1 = vmlaq_f64(resi1, a_reg, b_i1_reg);
        resi2 = vmlaq_f64(resi2, a_reg, b_i2_reg);
        resi3 = vmlaq_f64(resi3, a_reg, b_i3_reg);
        resi4 = vmlaq_f64(resi4, a_reg, b_i4_reg);
        resi5 = vmlaq_f64(resi5, a_reg, b_i5_reg);
        resi6 = vmlaq_f64(resi6, a_reg, b_i6_reg);
        resi7 = vmlaq_f64(resi7, a_reg, b_i7_reg);
 
        a_cur += 2;
        b_i0_cur += 2;
        b_i1_cur += 2;
        b_i2_cur += 2;
        b_i3_cur += 2;
        b_i4_cur += 2;
        b_i5_cur += 2;
        b_i6_cur += 2;
        b_i7_cur += 2;
    }
 
 
    *(c ) = resi0[0] + resi0[1];
    *(c + 1) = resi1[0] + resi1[1];
    *(c + 2) = resi2[0] + resi2[1];
    *(c + 3) = resi3[0] + resi3[1];
    *(c + 4) = resi4[0] + resi4[1];
    *(c + 5) = resi5[0] + resi5[1];
    *(c + 6) = resi6[0] + resi6[1];
    *(c + 7) = resi7[0] + resi7[1];
}
 
		int m, q, n, k;
    double a[7200];
    PackMatrix(a, old_a, 60, 120, 60);
    double *a_cur = a;
    // double mid_res[3600];

    for (m = 0; m < 60; m++)
    {
        /* ---------------è®¡ç®—å‰ä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜----------------*/
        double mid_res[60];
        double *mid_res_cur = mid_res;
        for (q = 0; q + 8 < 60; q += 8, mid_res_cur += 8)
        {
            double tmp_value = 0.0;
            // ä¸€æ¬¡è®¡ç®—å‡º8ä¸ªæ•°å­—å³m*8ä¸ª
            // ------- è¿™é‡Œç”±äºè¦å†™å›ç»“æœï¼Œæ‰€ä»¥æœ€åä¸€ä¸ªä½ç½®å¾—æ˜¯åŸå§‹çš„æŒ‡é’ˆè€Œéåœ°å€åŠ å’Œçš„ç»“æœ
            Matrix1x8(120, a_cur, b + 120 * q, mid_res_cur);
        }
        for (; q < 60; q++, mid_res_cur++)
        {
            double tmp_value = 0.0;
            // ä¸€ä¸ªä¸€ä¸ªç®—
            for (k = 0; k < 120; k++)
            { // ä¸­é—´æ•°
                tmp_value += *(a_cur + k) * *(b + k + q * 120);
            }
            *(mid_res_cur) = tmp_value;
        }
        /* ---------------è®¡ç®—åä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜----------------*/
        mid_res_cur = mid_res;
        for (n = 0; n < 60; n++)
        {
            double tmp_value = 0.0;
            for (q = 0; q < 60; q++)
            { // ä¸­é—´æ•°
                tmp_value += *(mid_res_cur + q) * c[q + n * 60];
            }
            res[m + n * 60] = tmp_value;
        }
        a_cur += 120;
    }
```

- Time Cost
    
    ```cpp
    HACK10 time_cost: 4.07655 ms,
    
    calc_constraint time_cost: 9.34554 ms,
    
    HACK10 time_cost: 4.03455 ms,
    
    calc_constraint time_cost: 9.25598 ms,
    
    HACK10 time_cost: 4.02991 ms,
    
    calc_constraint time_cost: 9.18046 ms,
    
    HACK10 time_cost: 4.01719 ms,
    
    calc_constraint time_cost: 9.15646 ms,
    
    HACK10 time_cost: 4.02091 ms,
    
    calc_constraint time_cost: 9.15954 ms,
    
    HACK10 time_cost: 4.01279 ms,
    
    calc_constraint time_cost: 9.1465 ms,
    
    HACK10 time_cost: 4.04455 ms,
    
    calc_constraint time_cost: 9.2591 ms,
    
    HACK10 time_cost: 4.03239 ms,
    
    calc_constraint time_cost: 9.22822 ms,
    
    HACK10 time_cost: 4.02591 ms,
    
    calc_constraint time_cost: 9.17198 ms,
    
    HACK10 time_cost: 4.01255 ms,
    
    calc_constraint time_cost: 9.15226 ms,
    
    HACK10 time_cost: 4.01455 ms,
    
    calc_constraint time_cost: 9.1439 ms,
    
    HACK10 time_cost: 4.01919 ms,
    
    calc_constraint time_cost: 9.15514 ms,
    
    HACK10 time_cost: 4.01731 ms,
    
    calc_constraint time_cost: 9.20454 ms,
    
    HACK10 time_cost: 4.02623 ms,
    
    calc_constraint time_cost: 9.21506 ms,
    
    HACK10 time_cost: 4.08231 ms,
    
    calc_constraint time_cost: 9.2895 ms,
    
    HACK10 time_cost: 4.09163 ms,
    
    calc_constraint time_cost: 9.25938 ms,
    
    HACK10 time_cost: 4.01971 ms,
    
    calc_constraint time_cost: 9.18566 ms,
    
    HACK10 time_cost: 4.01903 ms,
    
    calc_constraint time_cost: 9.15638 ms,
    
    HACK10 time_cost: 4.01891 ms,
    
    calc_constraint time_cost: 9.1685 ms,
    
    HACK10 time_cost: 4.01411 ms,
    
    calc_constraint time_cost: 9.16246 ms,
    ```
    

## X86

### **INTRINSICâ€”â€”128ä½**

```cpp
for (i = 0; i < 60; i++) {
        float mid_res[60];
        float *mid_res_cur = mid_res;
        for (k = 0; k < 60; k++) {
            int mul_k = k * 60, mul_k1 = mul_k << 1;
            __m128d tmp_value;
            __m128d a_reg, b_reg;
            tmp_value = _mm_setzero_pd();
            for (i_0 = 0; i_0 < 120; i_0 += 2) {
                a_reg = _mm_set_pd(localB->Cc[60 * i_0 + i], localB->Cc[60 * (i_0 + 1) + i]);
                b_reg = _mm_set_pd(b[mul_k1 + i_0], b[mul_k1 + i_0 + 1]);
                tmp_value += a_reg * b_reg;
            }
            mid_res[i + mul_k] = tmp_value[0] + tmp_value[1];
            (*mid_res_cur++) = tmp_value[0] + tmp_value[1];
        }
        for (k = 0; k < 60; k++) {
            int mul_k = k * 60;
            // double tmp_value = 0.0;
            __m128d tmp_value;
            __m128d c_reg, mid_res_reg;
            mid_res_cur = mid_res;
            tmp_value = _mm_setzero_pd();
            for (i_0 = 0; i_0 < 60; i_0 += 2) {
                c_reg = _mm_set_pd(c[mul_k + i_0], c[mul_k + i_0 + 1]);
                mid_res_reg = _mm_set_pd(*mid_res_cur, *(mid_res_cur + 1));
                tmp_value += c_reg * mid_res_reg;
                mid_res_cur += 2;
            }
            res[i + mul_k] = tmp_value[0] + tmp_value[1];
        }
    }
```

- Time Cost
    
    ```cpp
    HACK10 time_cost: 2.18061 ms,
    calc_constraint time_cost: 3.83082 ms,
    
    HACK10 time_cost: 2.04163 ms,
    calc_constraint time_cost: 3.61122 ms,
    
    HACK10 time_cost: 2.34942 ms,
    calc_constraint time_cost: 4.07484 ms,
    
    HACK10 time_cost: 1.98357 ms,
    calc_constraint time_cost: 3.56842 ms,
    
    HACK10 time_cost: 1.98203 ms,
    calc_constraint time_cost: 3.60502 ms,
    
    HACK10 time_cost: 2.31218 ms,
    calc_constraint time_cost: 4.04753 ms,
    
    HACK10 time_cost: 1.93185 ms,
    calc_constraint time_cost: 3.51748 ms,
    
    HACK10 time_cost: 2.03343 ms,
    calc_constraint time_cost: 3.6022 ms,
    
    HACK10 time_cost: 2.02896 ms,
    calc_constraint time_cost: 3.60189 ms,
    
    HACK10 time_cost: 2.16223 ms,
    calc_constraint time_cost: 3.81065 ms,
    
    HACK10 time_cost: 2.10601 ms,
    calc_constraint time_cost: 3.72069 ms,
    
    HACK10 time_cost: 1.94567 ms,
    calc_constraint time_cost: 3.53453 ms,
    
    HACK10 time_cost: 1.98918 ms,
    calc_constraint time_cost: 3.54228 ms,
    
    HACK10 time_cost: 1.91518 ms,
    calc_constraint time_cost: 3.42948 ms,
    
    HACK10 time_cost: 2.09653 ms,
    calc_constraint time_cost: 3.67056 ms,
    
    HACK10 time_cost: 2.21421 ms,
    calc_constraint time_cost: 3.83986 ms,
    
    HACK10 time_cost: 2.06236 ms,
    calc_constraint time_cost: 3.65216 ms,
    
    HACK10 time_cost: 1.94704 ms,
    calc_constraint time_cost: 3.52995 ms,
    
    HACK10 time_cost: 2.16676 ms,
    calc_constraint time_cost: 3.73122 ms,
    
    HACK10 time_cost: 2.12721 ms,
    calc_constraint time_cost: 3.73529 ms,
    ```
    

### Eigen

```cpp
Eigen::MatrixXd Mat11(60,120);
    Eigen::MatrixXd Mat12(120, 60);
    for(int m = 0 ; m < 60 ; m++){
        for(int k = 0 ; k < 120 ; k++){
            Mat11(m, k) = a[m + 60 * k];
            Mat12(k, m) = b[k + m*120];
        }
    }
 
    Eigen::MatrixXd mid_res(60, 60);
    std::cout<<""<<std::endl;
    start_t=std::chrono::high_resolution_clock::now();
    mid_res = Mat11 * Mat12; // 3.35ms
    end_t = std::chrono::high_resolution_clock::now();
    fp_ms = end_t - start_t;
    std::cout << "Mat11 * Mat12 : " << fp_ms.count() << " ms, " << std::endl;
 
    Eigen::MatrixXd Mat22(60, 60);
    for(int q = 0 ; q < 60 ; q++){
        for(int n = 0 ; n < 60 ; n++){
            Mat22(q,n) = c[q + n * 60];
        }
    }
 
    Eigen::MatrixXd eigen_res(60, 60);
    start_t=std::chrono::high_resolution_clock::now();
    eigen_res = mid_res * Mat22;
    std::cout << "Mat21 * Mat22 : " << fp_ms.count() << " ms, " << std::endl;
 
    for(int m = 0 ; m < 60 ; m ++){
        for(int n = 0 ; n < 60 ; n++){
            res_write_back[m + n * 60] = eigen_res(m, n);
        }
    }
```

- Time Cost
    
    ```cpp
    Mat11 * Mat12 : 3.70042 ms,
    Mat21 * Mat22 : 3.70042 ms,
    HACK10 time_cost: 7.20633 ms,
    calc_constraint time_cost: 8.65773 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.66642 ms,
    Mat21 * Mat22 : 3.66642 ms,
    HACK10 time_cost: 7.15719 ms,
    calc_constraint time_cost: 8.60124 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.6529 ms,
    Mat21 * Mat22 : 3.6529 ms,
    HACK10 time_cost: 7.13826 ms,
    calc_constraint time_cost: 8.61267 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.80242 ms,
    Mat21 * Mat22 : 3.80242 ms,
    HACK10 time_cost: 7.3256 ms,
    calc_constraint time_cost: 8.85386 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.91069 ms,
    Mat21 * Mat22 : 3.91069 ms,
    HACK10 time_cost: 7.50605 ms,
    calc_constraint time_cost: 8.96736 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.8325 ms,
    Mat21 * Mat22 : 3.8325 ms,
    HACK10 time_cost: 7.37886 ms,
    calc_constraint time_cost: 8.89347 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.98222 ms,
    Mat21 * Mat22 : 3.98222 ms,
    HACK10 time_cost: 7.81 ms,
    calc_constraint time_cost: 9.50526 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 4.0748 ms,
    Mat21 * Mat22 : 4.0748 ms,
    HACK10 time_cost: 7.74117 ms,
    calc_constraint time_cost: 9.5586 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 4.57249 ms,
    Mat21 * Mat22 : 4.57249 ms,
    HACK10 time_cost: 8.98205 ms,
    calc_constraint time_cost: 10.7099 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.97924 ms,
    Mat21 * Mat22 : 3.97924 ms,
    HACK10 time_cost: 7.53186 ms,
    calc_constraint time_cost: 9.21196 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.76313 ms,
    Mat21 * Mat22 : 3.76313 ms,
    HACK10 time_cost: 7.31851 ms,
    calc_constraint time_cost: 8.75915 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.71624 ms,
    Mat21 * Mat22 : 3.71624 ms,
    HACK10 time_cost: 7.28023 ms,
    calc_constraint time_cost: 8.72938 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.93559 ms,
    Mat21 * Mat22 : 3.93559 ms,
    HACK10 time_cost: 7.53316 ms,
    calc_constraint time_cost: 9.01973 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.71314 ms,
    Mat21 * Mat22 : 3.71314 ms,
    HACK10 time_cost: 7.28482 ms,
    calc_constraint time_cost: 8.71507 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 4.07832 ms,
    Mat21 * Mat22 : 4.07832 ms,
    HACK10 time_cost: 7.96863 ms,
    calc_constraint time_cost: 9.65822 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.97965 ms,
    Mat21 * Mat22 : 3.97965 ms,
    HACK10 time_cost: 7.52208 ms,
    calc_constraint time_cost: 8.96079 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.72727 ms,
    Mat21 * Mat22 : 3.72727 ms,
    HACK10 time_cost: 7.28932 ms,
    calc_constraint time_cost: 8.73136 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.79583 ms,
    Mat21 * Mat22 : 3.79583 ms,
    HACK10 time_cost: 7.40721 ms,
    calc_constraint time_cost: 8.83646 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.96747 ms,
    Mat21 * Mat22 : 3.96747 ms,
    HACK10 time_cost: 7.61735 ms,
    calc_constraint time_cost: 9.18379 ms,
    --------------------------------------
    
    Mat11 * Mat12 : 3.76628 ms,
    Mat21 * Mat22 : 3.76628 ms,
    HACK10 time_cost: 7.34889 ms,
    calc_constraint time_cost: 8.85238 ms,
    --------------------------------------
    ```
    

### **Eigenâ€”â€”MKL**

ç¬¬ä¸€æ¬¡è®¡ç®—çš„æ—¶å€™æ—¶é—´ç‰¹åˆ«é•¿ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼›åé¢çŸ©é˜µè®¡ç®—è™½ç„¶å¿«ï¼Œä½†æ€»çš„æ—¶é•¿æ¯”èµ·ç®€å•çš„è®¿å­˜ä¼˜åŒ–å¹¶ä¸å ä¼˜åŠ¿ï¼Œæ¨æµ‹æ˜¯å› ä¸ºçŸ©é˜µåˆ°Eigen Matrixçš„è½¬å˜ï¼ˆå†™å…¥å†™å›ï¼‰å¾ˆè€—æ—¶ï¼›// æ„Ÿè§‰é™¤éæŠŠç»“æ„ä½“é‡Œå¯¹åº”çš„çŸ©é˜µç±»å‹éƒ½å˜æˆEigençš„æ ‡å‡†çŸ©é˜µç±»å‹

- Time Cost
    
    ```cpp
    Mat11 * Mat12 : 31.3584 ms,
    Mat21 * Mat22 : 31.3584 ms,
    HACK10 time_cost: 33.2767 ms,
    calc_constraint time_cost: 35.2846 ms,
    
    Mat11 * Mat12 : 0.167863 ms,
    Mat21 * Mat22 : 0.167863 ms,
    HACK10 time_cost: 1.82158 ms,
    calc_constraint time_cost: 4.56614 ms,
    
    Mat11 * Mat12 : 0.158589 ms,
    Mat21 * Mat22 : 0.158589 ms,
    HACK10 time_cost: 1.87742 ms,
    calc_constraint time_cost: 3.97403 ms,
    
    Mat11 * Mat12 : 0.148654 ms,
    Mat21 * Mat22 : 0.148654 ms,
    HACK10 time_cost: 1.77342 ms,
    calc_constraint time_cost: 3.80751 ms,
    
    Mat11 * Mat12 : 0.150303 ms,
    Mat21 * Mat22 : 0.150303 ms,
    HACK10 time_cost: 1.78626 ms,
    calc_constraint time_cost: 3.82865 ms,
    
    Mat11 * Mat12 : 0.149528 ms,
    Mat21 * Mat22 : 0.149528 ms,
    HACK10 time_cost: 1.78479 ms,
    calc_constraint time_cost: 3.83011 ms,
    
    Mat11 * Mat12 : 0.152833 ms,
    Mat21 * Mat22 : 0.152833 ms,
    HACK10 time_cost: 1.86897 ms,
    calc_constraint time_cost: 3.94441 ms,
    
    Mat11 * Mat12 : 0.155455 ms,
    Mat21 * Mat22 : 0.155455 ms,
    HACK10 time_cost: 1.82867 ms,
    calc_constraint time_cost: 3.91908 ms,
    
    Mat11 * Mat12 : 0.156514 ms,
    Mat21 * Mat22 : 0.156514 ms,
    HACK10 time_cost: 1.75267 ms,
    calc_constraint time_cost: 3.82577 ms,
    
    Mat11 * Mat12 : 0.157453 ms,
    Mat21 * Mat22 : 0.157453 ms,
    HACK10 time_cost: 1.84311 ms,
    calc_constraint time_cost: 3.87428 ms,
    
    Mat11 * Mat12 : 0.159454 ms,
    Mat21 * Mat22 : 0.159454 ms,
    HACK10 time_cost: 1.83495 ms,
    calc_constraint time_cost: 4.00669 ms,
    
    Mat11 * Mat12 : 0.188351 ms,
    Mat21 * Mat22 : 0.188351 ms,
    HACK10 time_cost: 2.10202 ms,
    calc_constraint time_cost: 4.32377 ms,
    
    Mat11 * Mat12 : 0.152949 ms,
    Mat21 * Mat22 : 0.152949 ms,
    HACK10 time_cost: 1.79052 ms,
    calc_constraint time_cost: 3.85622 ms,
    
    Mat11 * Mat12 : 0.157028 ms,
    Mat21 * Mat22 : 0.157028 ms,
    HACK10 time_cost: 1.84283 ms,
    calc_constraint time_cost: 3.90262 ms,
    
    Mat11 * Mat12 : 0.203668 ms,
    Mat21 * Mat22 : 0.203668 ms,
    HACK10 time_cost: 2.02796 ms,
    calc_constraint time_cost: 4.22465 ms,
    
    Mat11 * Mat12 : 0.157544 ms,
    Mat21 * Mat22 : 0.157544 ms,
    HACK10 time_cost: 1.85641 ms,
    calc_constraint time_cost: 3.93543 ms,
    
    Mat11 * Mat12 : 0.174231 ms,
    Mat21 * Mat22 : 0.174231 ms,
    HACK10 time_cost: 1.82291 ms,
    calc_constraint time_cost: 3.89065 ms,
    
    Mat11 * Mat12 : 0.156635 ms,
    Mat21 * Mat22 : 0.156635 ms,
    HACK10 time_cost: 1.85297 ms,
    calc_constraint time_cost: 3.919 ms,
    
    Mat11 * Mat12 : 0.149842 ms,
    Mat21 * Mat22 : 0.149842 ms,
    HACK10 time_cost: 1.84868 ms,
    calc_constraint time_cost: 3.90904 ms,
    
    Mat11 * Mat12 : 0.16338 ms,
    Mat21 * Mat22 : 0.16338 ms,
    HACK10 time_cost: 1.97972 ms,
    calc_constraint time_cost: 4.1162 ms,
    ```
    

## æ€è€ƒ

<aside>
ğŸ‘¾ ä¼˜åŒ–æ€è·¯

å…¶å®SEGMMçš„ä¼˜åŒ–æ€è·¯ï¼Œæ˜¯æ›´å¥½åœ°ä½¿ç”¨simdï¼›è€Œsimdçš„æ€è·¯ï¼Œå°±æ˜¯ä¸€æ¡æŒ‡ä»¤å®Œæˆå¤šä¸ªè®¡ç®—æ“ä½œï¼Œè¿™æ ·å®é™…ä¸Šæ˜¯åœ¨å‡å°‘æŒ‡ä»¤çš„å¹³å‡æ—¶é’Ÿå‘¨æœŸæ•°ã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¿˜è¦è®©ä»£ç é…åˆç¼“å­˜å·¥ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå°½é‡è®©ä¸‹æ¬¡è¯»æ•°çš„æ—¶å€™åˆ«å»å†…å­˜è¯»ï¼Œå› æ­¤è¦æŠŠè¡Œä¹˜çŸ©é˜µæ‰“åŒ…æˆè¡Œå­˜å‚¨ï¼Œåˆ—ä¹˜çŸ©é˜µæ‰“åŒ…æˆåˆ—å­˜å‚¨ã€‚

</aside>